---
title: "Estimate concordance"
author: "Matt Ploenzke"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Estimate concordance}
  %\VignetteEngine{knitr::rmarkdown}
  \usepackage[utf8]{inputenc}
---

### Set up

```{r setup, include=FALSE}
rm(list=ls(all=TRUE))
knitr::opts_chunk$set(echo = TRUE)
library(concordResponse)
library(tidyverse)
```

Set options.
```{r}
opt <- list()
opt$datasets <- c('CCLE','GDSC') # CCLE GDSC GDSC1000 gCSI CMAP
opt$log_dir <- paste(paste(opt$datasets,collapse='_'),'LOvsCORR',sep='_')
opt$sensitivity_measure <- c('ec50') # raw_auc e_inf hill_slope ec50
opt$use_small_datasets <- FALSE
```

Set up log directory.
```{r}
dir.create(opt$log_dir,showWarnings = FALSE)
```

### Import data

First download the full datasets.
```{r,eval=FALSE}
PharmacoGx::availablePSets()
for (dataset in opt$datasets) {
  PharmacoGx::downloadPSet(dataset)
}
```

Load data.
```{r}
for (dataset in opt$datasets) {
  load(file.path('../PSets',paste(dataset,'RData',sep='.')))
}
if (opt$use_small_datasets) {
  CCLE <- PharmacoGx::CCLEsmall
  GDSC <- PharmacoGx::GDSCsmall
}
```

Format the experiment data for pairwise comparisons. Find cells and drugs assayed across experiment. Remove noisy experiments and mislabelled cell lines. Calculate sensitivity measures per cell/drug.
```{r}
sensitivity.tibble.list <- intersectPSetWrapper(datasets = opt$datasets,
                                                minimum_intersection = length(opt$datasets),
                                                intersectOn = c('cell.lines','drugs'),
                                                sensitivity_measure = opt$sensitivity_measure,
                                                remove_noisy_curves = FALSE,
                                                remove_mislabelled_cells = FALSE)
eval(parse(text=paste('rm(',paste(opt$datasets,collapse=','),')',sep='')))
```


### Fit two-component normal mixture

Estimate posterior probability via EM for 2-mixture gaussian drugs.
```{r}
twonormals.tibble.list <- lapply(sensitivity.tibble.list, function(tibb) {
  calcMixture(tibb, prior_proportion=.95)
})
```

### Normal mixture plots

Plot these distributions for each measure with fitted mixture gaussians.
```{r}
for (meas in opt$sensitivity_measure) {
  for (comp in names(twonormals.tibble.list)) {
    normaldens <- twonormals.tibble.list[[comp]][[2]] %>%
      mutate(cross = paste(Sensitive, experiment, drug, sep='_')) %>%
      plyr::ddply(., "cross", function(df) {
      data.frame( 
        value = seq(0, 1, length = 1000),
        normal_curve = dnorm(seq(0, 1, length = 1000), 
                             mean=df$posterior_mu, 
                             sd=df$posterior_sigma) 
      )
    })
    normaldens <- as.tibble(normaldens) %>% 
      separate(cross,into=c('Sensitive','experiment','drug'),sep='_') %>%
      group_by(experiment, drug) %>%
      mutate(normal_curve = normal_curve / sum(normal_curve)) %>%
      ungroup() %>%
      filter(normal_curve>1e-5)
    twonormals.tibble.list[[comp]][[1]] %>%
      filter(measure==meas) %>%
      ggplot(aes(value)) +
        stat_bin(aes(y=..count../sum(..count..)),bins=50) + 
        theme_minimal() + 
        facet_grid(cols = vars(experiment),rows=vars(drug), scales = 'free_y') + 
        theme(strip.text.x = element_text(size = 8), legend.position="none") + 
      scale_x_continuous(limits = c(0,1), name=meas) + 
      geom_line(data=normaldens, aes(y = normal_curve, color=Sensitive), lwd = 1.5)
    ggsave(file=file.path(opt$log_dir,meas,comp,paste('densities_twonormals.pdf',sep='')),width = 12, height = 24, units = "in")
  }
}
while(dev.cur()!=1) {dev.off()}
```

Do the same thing but against a smoothed density instead of histogram.
```{r}
for (meas in opt$sensitivity_measure) {
  for (comp in names(twonormals.tibble.list)) {
    normaldens <- twonormals.tibble.list[[comp]][[2]] %>%
      mutate(cross = paste(Sensitive, experiment, drug, sep='_')) %>%
      plyr::ddply(., "cross", function(df) {
      data.frame( 
        value = seq(0, 1, length = 1000),
        normal_curve = dnorm(seq(0, 1, length = 1000), 
                             mean=df$posterior_mu, 
                             sd=df$posterior_sigma) 
      )
    })
    normaldens <- as.tibble(normaldens) %>% 
      separate(cross,into=c('Sensitive','experiment','drug'),sep='_') %>%
      group_by(experiment, drug) %>%
      #mutate(normal_curve = normal_curve / sum(normal_curve)) %>%
      ungroup() %>%
      filter(normal_curve>1e-5)
    twonormals.tibble.list[[comp]][[1]] %>%
      ggplot(aes(value)) +
        geom_density(adjust=.5,fill=1) +
        theme_minimal() + 
        facet_grid(cols = vars(experiment),rows=vars(drug), scales = 'free_y') + 
        theme(strip.text.x = element_text(size = 8), legend.position="none") + 
      scale_x_continuous(limits = c(0,1), name=meas) + 
      geom_line(data=normaldens, aes(y = normal_curve, color=Sensitive), lwd = 1.5)
    ggsave(file=file.path(opt$log_dir,meas,comp,paste('densities_smoothed_twonormals.pdf',sep='')),width = 12, height = 24, units = "in")
  }
}
while(dev.cur()!=1) {dev.off()}
```

Plot the pairwise concordance between two studies at a time with the posterior agreement.
```{r}
for (meas in opt$sensitivity_measure) {
  for (comp in names(twonormals.tibble.list)) {
    combos <- t(combn(sort(unique(twonormals.tibble.list[[comp]][[1]]$experiment)),2))
    for (combo in 1:nrow(combos)) {
      twonormals.tibble.list[[comp]][[1]] %>%
        filter(experiment %in% combos[combo,],
               measure == meas) %>%
        select(drug,cell,experiment, measure, everything()) %>%
        gather(variable, value, -(drug:measure)) %>% 
        unite(temp, experiment, variable) %>%
        spread(temp,value) %>%
        mutate_(t1 = paste(combos[combo,1],'posterior_Zmax',sep='_'),
                t2 = paste(combos[combo,2],'posterior_Zmax',sep='_'),
                posterior_Zmax = 't1 + t2') %>%
          mutate(called = ifelse(t1==1 & t2==0,paste(combos[combo,1],'sensitive'),
                                 ifelse(t1==1 & t2==1,paste(combos[combo,1],combos[combo,2],'sensitive'),
                                        ifelse(t1==0 & t2==1,paste(combos[combo,2],'sensitive'),
                                               paste(combos[combo,1],combos[combo,2],'resisteant'))))) %>% 
        select(-t1,-t2) %>% 
        ggplot(aes_string(x=paste(combos[combo,1],'value',sep='_'),
                          y=paste(combos[combo,2],'value',sep='_'))) + 
        geom_point(aes(color=as.factor(called)),alpha=.8,size=1.5) + 
        theme_minimal() + 
        facet_wrap(vars(drug),ncol=3) + 
        theme(strip.text.x = element_text(size = 8),
              legend.text=element_text(size=8),
              legend.title=element_text(size=0),
              legend.position='top') + 
        scale_x_continuous(breaks=c(0,.5,1),labels=c('0','0.5','1'),limits = c(0,1)) +
        scale_y_continuous(breaks=c(0,.5,1),labels=c('0','0.5','1'),limits = c(0,1))
    ggsave(file=file.path(opt$log_dir,meas,comp,paste('2way_',
                                            combos[combo,1],'_',combos[combo,2],
                                            '_twonormals.pdf',sep='')),
           width = 10, height = 18, units = "in")
    }
  }
}
```

Plot the contingency table.
```{r}
library(gridExtra)
for (meas in opt$sensitivity_measure) {
  for (comp in names(twonormals.tibble.list)) {
    dir.create(file.path(opt$log_dir,meas,comp,'Contingency_tables'),showWarnings = FALSE)
    combos <- t(combn(unique(twonormals.tibble.list[[comp]][[1]]$experiment),2))
    for (combo in 1:nrow(combos)) {
      for (dr in unique(twonormals.tibble.list[[comp]][[1]]$drug)) {
        sens.short <- twonormals.tibble.list[[comp]][[1]] %>%
          filter(experiment %in% combos[combo,],
               measure == meas,
               drug==dr) %>%
          select(cell,experiment, posterior_Zmax) %>%
          spread(experiment,posterior_Zmax) 
        tabb <- table(pull(sens.short[,combos[combo,1]]), pull(sens.short[,combos[combo,2]]))
        if (nrow(tabb)<2) {
          if (rownames(tabb)=='0') {
            tabb <- rbind(tabb,'1'=c(0,0))
          } else {
            tabb <- rbind('0'=c(0,0),tabb)
          }
        }
        if (ncol(tabb)<2) {
          if (colnames(tabb)=='0') {
            tabb <- cbind(tabb,'1'=c(0,0))
          } else {
            tabb <- cbind('0'=c(0,0),tabb)
          }
        }
        tabb[tabb==0] <- .5
        LOR <- log(tabb[1,1]*tabb[2,2])/(tabb[1,2]*tabb[2,1])
        tabb <- table(Study1=ifelse(as.logical(pull(sens.short[,combos[combo,1]])),'Sensitive','Resistant'),
                      Study2=ifelse(as.logical(pull(sens.short[,combos[combo,2]])),'Sensitive','Resistant'))
        if (nrow(tabb)<2) {
          if (rownames(tabb)=='Resistant') {
            tabb <- rbind(tabb,'Sensitive'=c(0,0))
          } else {
            tabb <- rbind('Resistant'=c(0,0),tabb)
          }
        }
        if (ncol(tabb)<2) {
          if (colnames(tabb)=='Resistant') {
            tabb <- cbind(tabb,'Sensitive'=c(0,0))
          } else {
            tabb <- cbind('Resistant'=c(0,0),tabb)
          }
        }
        qplot(1:10, 1:10, geom = "blank") + 
          theme_bw() + 
          theme(line = element_blank(), 
                text = element_blank()) +
          scale_x_continuous(breaks=c(0,.5,1),labels=NULL,limits = c(0,1),expand = expand_scale(add=c(.02, 0))) +
          scale_y_continuous(breaks=c(0,.5,1),labels=NULL,limits = c(0,1),expand = expand_scale(add=c(.02, 0))) + 
           annotation_custom(grob = tableGrob(tabb,theme=ttheme_minimal())) + 
          annotate('text',x=.17,y=.46,label='CCLE',angle = 90,size=5) + 
          annotate('text',x=.525,y=.625,label='GDSC',size=5)
        ggsave(file=file.path(opt$log_dir,meas,comp,'Contingency_tables',paste(dr,'_',
                                                                     combos[combo,1],'_',combos[combo,2],
                                                                     '_twonormals.pdf',sep='')),
               width = 6, height = 6, units = "in")
      }
    }
  }
}
```

Plot the model log likelihoods.
```{r}
library(ggrepel)
  for (meas in opt$sensitivity_measure) {
  for (comp in names(twonormals.tibble.list)) {
    combos <- t(combn(sort(unique(twonormals.tibble.list[[comp]][[1]]$experiment)),2))
    for (combo in 1:nrow(combos)) {
      twonormals.tibble.list[[comp]][[2]] %>%
        filter(experiment %in% combos[combo,],
               measure == meas) %>%
        group_by(experiment, drug) %>% 
        mutate(count = sum(count)) %>% 
        ungroup() %>%
        select(drug,experiment, loglik, count) %>%
        distinct() %>%
        mutate(loglik = ifelse(is.na(loglik),0,loglik/count)) %>% 
        spread(experiment,loglik) %>%
        ggplot(aes_string(x=combos[combo,1],
                          y=combos[combo,2],
                          label='drug')) + 
        geom_point(alpha=.8,size=1.5) + 
        geom_text_repel() + 
        theme_minimal() + 
        theme(strip.text.x = element_text(size = 8)) + 
        ggtitle('Mixed model log likelihoods')
    ggsave(file=file.path(opt$log_dir,meas,comp,paste('logliks_',
                                            combos[combo,1],'_',combos[combo,2],
                                            '_twonormals.pdf',sep='')),
           width = 10, height = 10, units = "in")
    }
  }
}
```

Plot the pairwise concordance between two studies at a time with the posterior probability of agreement.
```{r}
for (meas in opt$sensitivity_measure) {
  for (comp in names(twonormals.tibble.list)) {
    combos <- t(combn(sort(unique(twonormals.tibble.list[[comp]][[1]]$experiment)),2))
    for (combo in 1:nrow(combos)) {
      twonormals.tibble.list[[comp]][[1]] %>%
        filter(experiment %in% combos[combo,],
               measure == meas) %>%
        group_by(drug, cell, measure) %>%
        mutate(agreement = prod(posterior_Z0) + prod(posterior_Z1)) %>% 
        ungroup() %>% 
        select(drug,cell,experiment, agreement, measure, everything()) %>%
        gather(variable, value, -(drug:measure)) %>% 
        unite(temp, experiment, variable) %>%
        spread(temp,value) %>%
        ggplot(aes_string(x=paste(combos[combo,1],'value',sep='_'),
                          y=paste(combos[combo,2],'value',sep='_'))) + 
        geom_point(aes(color=agreement),alpha=1,size=2) + 
        scale_colour_gradient2(midpoint=.5,limits=c(0,1),mid='grey50') + 
        theme_minimal() + 
        facet_wrap(vars(drug),ncol=3) + 
        theme(strip.text.x = element_text(size = 8),
              legend.text=element_text(size=8),
              legend.title=element_text(size=0),
              legend.position='top') + 
        scale_x_continuous(breaks=c(0,.5,1),labels=c('0','0.5','1'),limits = c(0,1)) +
        scale_y_continuous(breaks=c(0,.5,1),labels=c('0','0.5','1'),limits = c(0,1))
    ggsave(file=file.path(opt$log_dir,meas,comp,paste('2way_agreement_',
                                            combos[combo,1],'_',combos[combo,2],
                                            '_twonormals.pdf',sep='')),
           width = 10, height = 18, units = "in")
    }
  }
}
```

### Fit two-component beta mixture

Estimate posterior probability via EM for 2-mixture beta drugs.
```{r}
twobetas.tibble.list <- lapply(sensitivity.tibble.list, function(tibb) {
  calcBetaMixture(tibb, prior_proportion=.8)
})
```

### Beta mixture plots

Plot these distributions for each measure with fitted mixture betas.
```{r}
for (meas in opt$sensitivity_measure) {
  for (comp in names(twobetas.tibble.list)) {
    betadens <- twobetas.tibble.list[[comp]][[2]] %>%
      mutate(cross = paste(Sensitive, experiment, drug, sep='_')) %>%
      plyr::ddply(., "cross", function(df) {
      data.frame( 
        value = seq(.01, .99, length = 1000),
        beta_curve = dbeta(seq(.01, .99, length = 1000), 
                             df$posterior_alpha, 
                             df$posterior_beta) 
      )
    })
    betadens <- as.tibble(betadens) %>% 
      separate(cross,into=c('Sensitive','experiment','drug'),sep='_') %>%
      group_by(experiment, drug) %>%
      mutate(beta_curve = beta_curve / sum(beta_curve[is.finite(beta_curve)])) %>%
      ungroup() %>%
      filter(beta_curve>1e-5)
    twobetas.tibble.list[[comp]][[1]] %>%
      filter(measure == meas) %>%
      ggplot(aes(value)) +
        stat_bin(aes(y=..count../sum(..count..)),bins=50) + 
        theme_minimal() + 
        facet_grid(cols = vars(experiment),rows=vars(drug), scales = 'free_y') + 
        theme(strip.text.x = element_text(size = 8), legend.position="none") + 
      scale_x_continuous(limits = c(0,1), name=meas) + 
      geom_line(data=betadens, aes(y = beta_curve, color=Sensitive), lwd = 1.5)
    ggsave(file=file.path(opt$log_dir,meas,comp,paste('densities_twobetas.pdf',sep='')),width = 12, height = 24, units = "in")
  }
}
while(dev.cur()!=1) {dev.off()}
```

Do the same thing but against a smoothed density instead of histogram.
```{r}
for (meas in opt$sensitivity_measure) {
  for (comp in names(twobetas.tibble.list)) {
    betadens <- twobetas.tibble.list[[comp]][[2]] %>%
      mutate(cross = paste(Sensitive, experiment, drug, sep='_')) %>%
      plyr::ddply(., "cross", function(df) {
      data.frame( 
        value = seq(.01, .99, length = 1000),
        beta_curve = dbeta(seq(.01, .99, length = 1000), 
                             df$posterior_alpha, 
                             df$posterior_beta) 
      )
    })
    betadens <- as.tibble(betadens) %>% 
      separate(cross,into=c('Sensitive','experiment','drug'),sep='_') %>%
      group_by(experiment, drug) %>%
      #mutate(beta_curve = beta_curve / sum(beta_curve)) %>%
      ungroup() %>%
      filter(beta_curve>1e-5)
    twobetas.tibble.list[[comp]][[1]] %>%
      ggplot(aes(value)) +
        geom_density(adjust=.5,fill=1) +
        theme_minimal() + 
        facet_grid(cols = vars(experiment),rows=vars(drug), scales = 'free_y') + 
        theme(strip.text.x = element_text(size = 8), legend.position="none") + 
      scale_x_continuous(limits = c(0,1), name=meas) + 
      geom_line(data=betadens, aes(y = beta_curve, color=Sensitive), lwd = 1.5)
    ggsave(file=file.path(opt$log_dir,meas,comp,paste('densities_smoothed_twobetas.pdf',sep='')),width = 12, height = 24, units = "in")
  }
}
while(dev.cur()!=1) {dev.off()}
```

Plot the pairwise concordance between two studies at a time with the posterior agreement.
```{r}
for (meas in opt$sensitivity_measure) {
  for (comp in names(twobetas.tibble.list)) {
    combos <- t(combn(sort(unique(twobetas.tibble.list[[comp]][[1]]$experiment)),2))
    for (combo in 1:nrow(combos)) {
      twobetas.tibble.list[[comp]][[1]] %>%
        filter(experiment %in% combos[combo,],
               measure == meas) %>%
        select(drug,cell,experiment, measure, everything()) %>%
        gather(variable, value, -(drug:measure)) %>% 
        unite(temp, experiment, variable) %>%
        spread(temp,value) %>%
        mutate_(t1 = paste(combos[combo,1],'posterior_Zmax',sep='_'),
                t2 = paste(combos[combo,2],'posterior_Zmax',sep='_'),
                posterior_Zmax = 't1 + t2') %>%
          mutate(called = ifelse(t1==1 & t2==0,paste(combos[combo,1],'sensitive'),
                                 ifelse(t1==1 & t2==1,paste(combos[combo,1],combos[combo,2],'sensitive'),
                                        ifelse(t1==0 & t2==1,paste(combos[combo,2],'sensitive'),
                                               paste(combos[combo,1],combos[combo,2],'resisteant'))))) %>% 
        select(-t1,-t2) %>% 
        ggplot(aes_string(x=paste(combos[combo,1],'value',sep='_'),
                          y=paste(combos[combo,2],'value',sep='_'))) + 
        geom_point(aes(color=as.factor(called)),alpha=.8,size=1.5) + 
        theme_minimal() + 
        facet_wrap(vars(drug),ncol=3) + 
        theme(strip.text.x = element_text(size = 8),
              legend.text=element_text(size=8),
              legend.title=element_text(size=0),
              legend.position='top') + 
        scale_x_continuous(breaks=c(0,.5,1),labels=c('0','0.5','1'),limits = c(0,1)) +
        scale_y_continuous(breaks=c(0,.5,1),labels=c('0','0.5','1'),limits = c(0,1))
    ggsave(file=file.path(opt$log_dir,meas,comp,paste('2way_',
                                            combos[combo,1],'_',combos[combo,2],
                                            '_twobetas.pdf',sep='')),
           width = 10, height = 18, units = "in")
    }
  }
}
```

Plot the contingency table.
```{r}
library(gridExtra)
for (meas in opt$sensitivity_measure) {
  for (comp in names(twobetas.tibble.list)) {
    dir.create(file.path(opt$log_dir,meas,comp,'Contingency_tables'),showWarnings = FALSE)
    combos <- t(combn(unique(twobetas.tibble.list[[comp]][[1]]$experiment),2))
    for (combo in 1:nrow(combos)) {
      for (dr in unique(twobetas.tibble.list[[comp]][[1]]$drug)) {
        sens.short <- twobetas.tibble.list[[comp]][[1]] %>%
          filter(experiment %in% combos[combo,],
               measure == meas,
               drug==dr) %>%
          select(cell,experiment, posterior_Zmax) %>%
          spread(experiment,posterior_Zmax) 
        tabb <- table(pull(sens.short[,combos[combo,1]]), pull(sens.short[,combos[combo,2]]))
        if (nrow(tabb)<2) {
          if (rownames(tabb)=='0') {
            tabb <- rbind(tabb,'1'=c(0,0))
          } else {
            tabb <- rbind('0'=c(0,0),tabb)
          }
        }
        if (ncol(tabb)<2) {
          if (colnames(tabb)=='0') {
            tabb <- cbind(tabb,'1'=c(0,0))
          } else {
            tabb <- cbind('0'=c(0,0),tabb)
          }
        }
        tabb[tabb==0] <- .5
        LOR <- log(tabb[1,1]*tabb[2,2])/(tabb[1,2]*tabb[2,1])
        tabb <- table(Study1=ifelse(as.logical(pull(sens.short[,combos[combo,1]])),'Sensitive','Resistant'),
                      Study2=ifelse(as.logical(pull(sens.short[,combos[combo,2]])),'Sensitive','Resistant'))
        if (nrow(tabb)<2) {
          if (rownames(tabb)=='Resistant') {
            tabb <- rbind(tabb,'Sensitive'=c(0,0))
          } else {
            tabb <- rbind('Resistant'=c(0,0),tabb)
          }
        }
        if (ncol(tabb)<2) {
          if (colnames(tabb)=='Resistant') {
            tabb <- cbind(tabb,'Sensitive'=c(0,0))
          } else {
            tabb <- cbind('Resistant'=c(0,0),tabb)
          }
        }
        qplot(1:10, 1:10, geom = "blank") + 
          theme_bw() + 
          theme(line = element_blank(), 
                text = element_blank()) +
          scale_x_continuous(breaks=c(0,.5,1),labels=NULL,limits = c(0,1),expand = expand_scale(add=c(.02, 0))) +
          scale_y_continuous(breaks=c(0,.5,1),labels=NULL,limits = c(0,1),expand = expand_scale(add=c(.02, 0))) + 
           annotation_custom(grob = tableGrob(tabb,theme=ttheme_minimal())) + 
          annotate('text',x=.17,y=.46,label='CCLE',angle = 90,size=5) + 
          annotate('text',x=.525,y=.625,label='GDSC',size=5)
        ggsave(file=file.path(opt$log_dir,meas,comp,'Contingency_tables',paste(dr,'_',
                                                                     combos[combo,1],'_',combos[combo,2],
                                                                     '_twobetas.pdf',sep='')),
               width = 6, height = 6, units = "in")
      }
    }
  }
}
```

Plot the model log likelihoods.
```{r}
library(ggrepel)
for (meas in opt$sensitivity_measure) {
  for (comp in names(twobetas.tibble.list)) {
    combos <- t(combn(sort(unique(twobetas.tibble.list[[comp]][[1]]$experiment)),2))
    for (combo in 1:nrow(combos)) {
      twobetas.tibble.list[[comp]][[2]] %>%
        filter(experiment %in% combos[combo,],
               measure == meas) %>%
        group_by(experiment, drug) %>% 
        mutate(count = n()) %>% 
        ungroup() %>%
        select(drug,experiment, loglik, count) %>%
        distinct() %>%
        mutate(loglik = ifelse(is.na(loglik),0,loglik/count)) %>% 
        spread(experiment,loglik) %>%
        ggplot(aes_string(x=combos[combo,1],
                          y=combos[combo,2],
                          label='drug')) + 
        geom_point(alpha=.8,size=1.5) + 
        geom_text_repel() + 
        theme_minimal() + 
        theme(strip.text.x = element_text(size = 8)) + 
        ggtitle('Mixed model log likelihoods')
    ggsave(file=file.path(opt$log_dir,meas,comp,paste('logliks_',
                                            combos[combo,1],'_',combos[combo,2],
                                            '_twobetas.pdf',sep='')),
           width = 10, height = 10, units = "in")
    }
  }
}
```

Plot the pairwise concordance between two studies at a time with the posterior probability of agreement.
```{r}
for (meas in opt$sensitivity_measure) {
  for (comp in names(twobetas.tibble.list)) {
    combos <- t(combn(sort(unique(twobetas.tibble.list[[comp]][[1]]$experiment)),2))
    for (combo in 1:nrow(combos)) {
      twobetas.tibble.list[[comp]][[1]] %>%
        filter(experiment %in% combos[combo,],
               measure == meas) %>%
        group_by(drug, cell, measure) %>%
        mutate(agreement = prod(posterior_Z0) + prod(posterior_Z1)) %>% 
        ungroup() %>% 
        select(drug,cell,experiment, agreement, measure, everything()) %>%
        gather(variable, value, -(drug:measure)) %>% 
        unite(temp, experiment, variable) %>%
        spread(temp,value) %>%
        ggplot(aes_string(x=paste(combos[combo,1],'value',sep='_'),
                          y=paste(combos[combo,2],'value',sep='_'))) + 
        geom_point(aes(color=agreement),alpha=1,size=2) + 
        scale_colour_gradient2(midpoint=.5,limits=c(0,1),mid='grey50') + 
        theme_minimal() + 
        facet_wrap(vars(drug),ncol=3) + 
        theme(strip.text.x = element_text(size = 8),
              legend.text=element_text(size=8),
              legend.title=element_text(size=0),
              legend.position='top') + 
        scale_x_continuous(breaks=c(0,.5,1),labels=c('0','0.5','1'),limits = c(0,1)) +
        scale_y_continuous(breaks=c(0,.5,1),labels=c('0','0.5','1'),limits = c(0,1))
    ggsave(file=file.path(opt$log_dir,meas,comp,paste('2way_agreement_',
                                            combos[combo,1],'_',combos[combo,2],
                                            '_twobetas.pdf',sep='')),
           width = 10, height = 18, units = "in")
    }
  }
}
```

### Fit a single gaussian

Fit a single normal distribution for broadly-acting drugs.
```{r}
onenormal.tibble.list <- lapply(sensitivity.tibble.list, function(tibb) {
  calcMLE(tibb, fit='normal')
})
```

### Gaussian plots

Qq-plot for these drugs. 
```{r}
for (meas in opt$sensitivity_measure) {
  for (comp in names(onenormal.tibble.list)) {
    dir.create(file.path(opt$log_dir,meas,comp,'QQ_plots'),showWarnings = FALSE)
    tempdat <- onenormal.tibble.list[[comp]][[2]] %>%
      filter(measure == meas) %>%
      mutate(drug = gsub('-','',.$drug),
        cross = paste(experiment, drug, sep='_')) %>%
      plyr::ddply(., "cross", function(df) {
      data.frame( 
        value = onenormal.tibble.list[[comp]][[1]] %>%
          mutate(drug = gsub('-','',.$drug)) %>%
          filter(measure == meas,
                 experiment == df$experiment,
                 drug == df$drug) %>%
          pull(value),
        prob = pnorm(onenormal.tibble.list[[comp]][[1]] %>%
          mutate(drug = gsub('-','',.$drug)) %>%
          filter(measure == meas,
                 experiment == df$experiment,
                 drug == df$drug) %>%
          pull(value), mean=df$param1, sd=df$param2),
        pval = ks.test(onenormal.tibble.list[[comp]][[1]] %>%
          mutate(drug = gsub('-','',.$drug)) %>%
          filter(measure == meas,
                 experiment == df$experiment,
                 drug == df$drug) %>%
          pull(value),y='pnorm',mean=df$param1,sd=df$param2)$p.value,
        param1 = df$param1,
        param2 = df$param2
      )
    }) %>%
      as.tibble() %>%
      separate(cross, into=c('experiment','drug')) %>%
      mutate(is.outlier = ifelse(prob>.9975 | prob<.0025,'red','black'))
    for (dr in unique(tempdat$drug)) {
      for (exper in unique(tempdat$experiment)) {
        tdat <- tempdat %>%
          filter(experiment == exper, drug == dr)
        is.outlier <- tdat %>% 
          arrange(prob) %>%
          pull(is.outlier)
        param1 <- tdat %>% 
          distinct(param1) %>%
          pull(param1)
        param2 <- tdat %>%
          distinct(param2) %>%
          pull(param2)
        ksval <- tdat %>%
          distinct(pval) %>%
          pull(pval)
        ggplot(data=tdat, aes(sample=value,color=is.outlier)) +
          stat_qq(distribution = qnorm, dparams = list(mean=param1,sd=param2),color=is.outlier,show.legend=FALSE) + 
          stat_qq_line(distribution = qnorm, dparams = list(mean=param1,sd=param2),color='black') + 
          annotate('text',x=0,y=1,label=paste('p=',round(ksval,3),sep='')) +
          theme_minimal() + 
          theme(strip.text.x = element_text(size = 8), legend.position="none")
        ggsave(file=file.path(opt$log_dir,meas,comp,'QQ_plots',paste(dr,'_',exper,'_onenormal.pdf',sep='')),
               width = 6, height = 6, units = "in")
      }
    }
  }
}
while(dev.cur()!=1) {dev.off()}
```

Plot the densities by drug again but with the single distribution overlaid.
```{r}
for (meas in opt$sensitivity_measure) {
  for (comp in names(onenormal.tibble.list)) {
    normaldens <- onenormal.tibble.list[[comp]][[2]] %>%
      filter(measure == meas) %>%
      mutate(cross = paste(experiment, drug, sep='_')) %>%
      plyr::ddply(., "cross", function(df) {
      data.frame( 
        value = seq(0, 1, length = 1000),
        normal_curve = dnorm(seq(0, 1, length = 1000), 
                             mean=df$param1, 
                             sd=df$param2) 
      )
    })
    normaldens <- as.tibble(normaldens) %>% 
      separate(cross,into=c('experiment','drug'),sep='_') %>%
      group_by(experiment, drug) %>%
      mutate(normal_curve = normal_curve / sum(normal_curve)) %>%
      ungroup() %>%
      filter(normal_curve>1e-5)
    onenormal.tibble.list[[comp]][[1]] %>%
      filter(measure == meas) %>%
      ggplot(aes(value)) +
        stat_bin(aes(y=..count../sum(..count..)),bins=50) + 
        theme_minimal() + 
        facet_grid(cols = vars(experiment),rows=vars(drug), scales = 'free_y') + 
        theme(strip.text.x = element_text(size = 8), legend.position="none") + 
      scale_x_continuous(limits = c(0,1), name=meas) + 
      geom_line(data=normaldens, aes(y = normal_curve), lwd = 1.5, color='blue')
    ggsave(file=file.path(opt$log_dir,meas,comp,paste('densities_onenormal.pdf',sep='')),width = 12, height = 24, units = "in")
  }
}
while(dev.cur()!=1) {dev.off()}
```

Repeat again with the smoothed densities instead of histograms.
```{r}
for (meas in opt$sensitivity_measure) {
  for (comp in names(onenormal.tibble.list)) {
    normaldens <- onenormal.tibble.list[[comp]][[2]] %>%
      mutate(cross = paste(experiment, drug, sep='_')) %>%
      plyr::ddply(., "cross", function(df) {
      data.frame( 
        value = seq(0, 1, length = 1000),
        normal_curve = dnorm(seq(0, 1, length = 1000), 
                             mean=df$param1, 
                             sd=df$param2) 
      )
    })
    normaldens <- as.tibble(normaldens) %>% 
      separate(cross,into=c('experiment','drug'),sep='_') %>%
      group_by(experiment, drug) %>%
      #mutate(normal_curve = normal_curve / sum(normal_curve)) %>%
      ungroup() %>%
      filter(normal_curve>1e-5)
    onenormal.tibble.list[[comp]][[1]] %>%
      ggplot(aes(value)) +
        geom_density(adjust=.5,fill=1) +
        theme_minimal() + 
        facet_grid(cols = vars(experiment),rows=vars(drug), scales = 'free_y') + 
        theme(strip.text.x = element_text(size = 8), legend.position="none") + 
      scale_x_continuous(limits = c(0,1), name=meas) + 
      geom_line(data=normaldens, aes(y = normal_curve), lwd = 1.5, color='blue')
    ggsave(file=file.path(opt$log_dir,meas,comp,paste('densities_smoothed_onenormal.pdf',sep='')),width = 12, height = 24, units = "in")
  }
}
while(dev.cur()!=1) {dev.off()}
```

Plot the model log likelihoods.
```{r}
for (meas in opt$sensitivity_measure) {
  for (comp in names(onenormal.tibble.list)) {
    combos <- t(combn(sort(unique(onenormal.tibble.list[[comp]][[1]]$experiment)),2))
    for (combo in 1:nrow(combos)) {
      onenormal.tibble.list[[comp]][[1]] %>% 
        filter(experiment %in% combos[combo,],
               measure == meas) %>%
        left_join(onenormal.tibble.list[[comp]][[2]], by=c('experiment','measure','drug')) %>%
        mutate(likelihood = dnorm(.$value,param1,param2)) %>%
        group_by(experiment, drug) %>%
        summarise(loglik = sum(log(likelihood))/n()) %>%
        ungroup() %>%
        select(drug,experiment, loglik) %>%
        distinct() %>%
        spread(experiment,loglik) %>%
        ggplot(aes_string(x=combos[combo,1],
                          y=combos[combo,2],
                          label='drug')) + 
        geom_point(alpha=.8,size=1.5) + 
        geom_text_repel() + 
        theme_minimal() + 
        theme(strip.text.x = element_text(size = 8)) + 
        ggtitle('Gaussian average log likelihoods')
    ggsave(file=file.path(opt$log_dir,meas,comp,paste('logliks_',
                                            combos[combo,1],'_',combos[combo,2],
                                            '_onenormal.pdf',sep='')),
           width = 10, height = 10, units = "in")
    }
  }
}
```

Plot the pairwise concordance between two studies at a time with the posterior probability of agreement.
```{r}
for (meas in opt$sensitivity_measure) {
  for (comp in names(onenormal.tibble.list)) {
    combos <- t(combn(sort(unique(onenormal.tibble.list[[comp]][[1]]$experiment)),2))
    for (combo in 1:nrow(combos)) {
      onenormal.tibble.list[[comp]][[1]] %>%
        filter(experiment %in% combos[combo,],
               measure == meas) %>%
        group_by(drug, cell, measure) %>%
        mutate(agreement = prod(prob) + prod(1-prob)) %>% 
        ungroup() %>% 
        select(drug,cell,experiment, agreement, measure, everything()) %>%
        gather(variable, value, -(drug:measure)) %>% 
        unite(temp, experiment, variable) %>%
        spread(temp,value) %>%
        ggplot(aes_string(x=paste(combos[combo,1],'value',sep='_'),
                          y=paste(combos[combo,2],'value',sep='_'))) + 
        geom_point(aes(color=agreement),alpha=1,size=2) + 
        scale_colour_gradient2(midpoint=.5,limits = c(0,1),mid='grey50') + 
        theme_minimal() + 
        facet_wrap(vars(drug),ncol=3) + 
        theme(strip.text.x = element_text(size = 8),
              legend.text=element_text(size=8),
              legend.title=element_text(size=0),
              legend.position='top') + 
        scale_x_continuous(breaks=c(0,.5,1),labels=c('0','0.5','1'),limits = c(0,1)) +
        scale_y_continuous(breaks=c(0,.5,1),labels=c('0','0.5','1'),limits = c(0,1))
    ggsave(file=file.path(opt$log_dir,meas,comp,paste('2way_agreement_',
                                            combos[combo,1],'_',combos[combo,2],
                                            '_onenormal.pdf',sep='')),
           width = 10, height = 18, units = "in")
    }
  }
}
```

### Fit a single beta

Try a beta distribution instead.
```{r}
onebeta.tibble.list <- lapply(sensitivity.tibble.list, function(tibb) {
  calcMLE(tibb, fit='beta')
})
```

### Beta plots

Qq-plot for the beta fits.  
```{r}
for (meas in opt$sensitivity_measure) {
  for (comp in names(onebeta.tibble.list)) {
    tempdat <- onebeta.tibble.list[[comp]][[2]] %>%
      filter(measure == meas) %>%
      mutate(drug = gsub('-','',.$drug),
        cross = paste(experiment, drug, sep='_')) %>%
      plyr::ddply(., "cross", function(df) {
      data.frame( 
        value = onebeta.tibble.list[[comp]][[1]] %>%
          mutate(drug = gsub('-','',.$drug)) %>%
          filter(measure == meas,
                 experiment == df$experiment,
                 drug == df$drug) %>%
          pull(value),
        prob = pbeta(onebeta.tibble.list[[comp]][[1]] %>%
          mutate(drug = gsub('-','',.$drug)) %>%
          filter(measure == meas,
                 experiment == df$experiment,
                 drug == df$drug) %>%
          pull(value), df$param1, df$param2),
        pval = ks.test(onebeta.tibble.list[[comp]][[1]] %>%
          mutate(drug = gsub('-','',.$drug)) %>%
          filter(measure == meas,
                 experiment == df$experiment,
                 drug == df$drug) %>%
          pull(value),
          y='pbeta',df$param1,df$param2)$p.value,
        param1 = df$param1,
        param2 = df$param2
      )
    }) %>%
      as.tibble() %>%
      separate(cross, into=c('experiment','drug')) %>%
      mutate(is.outlier = ifelse(prob>.9975 | prob<.0025,'red','black'))
    for (dr in unique(tempdat$drug)) {
      for (exper in unique(tempdat$experiment)) {
        tdat <- tempdat %>%
          filter(experiment == exper, drug == dr)
        is.outlier <- tdat %>% 
          arrange(prob) %>%
          pull(is.outlier)
        param1 <- tdat %>% 
          distinct(param1) %>%
          pull(param1)
        param2 <- tdat %>%
          distinct(param2) %>%
          pull(param2)
        ksval <- tdat %>%
          distinct(pval) %>%
          pull(pval)
        ggplot(data=tdat, aes(sample=value,color=is.outlier)) +
          stat_qq(distribution = qbeta, dparams = list(param1,param2),color=is.outlier,show.legend=FALSE) + 
          stat_qq_line(distribution = qbeta, dparams = list(param1,param2),color='black') + 
          annotate('text',x=0,y=1,label=paste('p=',round(ksval,3),sep='')) +
          theme_minimal() + 
          theme(strip.text.x = element_text(size = 8), legend.position="none")
        ggsave(file=file.path(opt$log_dir,meas,comp,'QQ_plots',paste(dr,'_',exper,'_onebeta.pdf',sep='')),
               width = 6, height = 6, units = "in")
      }
    }
  }
}
while(dev.cur()!=1) {dev.off()}
```

Plot the densities by drug again but with the single beta distribution overlaid.
```{r}
for (meas in opt$sensitivity_measure) {
  for (comp in names(onebeta.tibble.list)) {
    betadens <- onebeta.tibble.list[[comp]][[2]] %>%
      filter(measure == meas) %>%
      mutate(cross = paste(experiment, drug, sep='_')) %>%
      plyr::ddply(., "cross", function(df) {
      data.frame( 
        value = seq(.01, .99, length = 1000),
        beta_curve = dbeta(seq(.01, .99, length = 1000), 
                             df$param1, 
                             df$param2) 
      )
    })
    betadens <- as.tibble(betadens) %>% 
      separate(cross,into=c('experiment','drug'),sep='_') %>%
      group_by(experiment, drug) %>%
      mutate(beta_curve = beta_curve / sum(beta_curve[is.finite(beta_curve)])) %>%
      ungroup()
    onebeta.tibble.list[[comp]][[1]] %>%
      filter(measure == meas) %>%
      ggplot(aes(value)) +
        stat_bin(aes(y=..count../sum(..count..)),bins=50) + 
        theme_minimal() + 
        facet_grid(cols = vars(experiment),rows=vars(drug), scales = 'free_y') + 
        theme(strip.text.x = element_text(size = 8), legend.position="none") + 
      scale_x_continuous(limits = c(0,1), name=meas) + 
      geom_line(data=betadens, aes(y = beta_curve), lwd = 1.5, color='blue')
    ggsave(file=file.path(opt$log_dir,meas,comp,paste('densities_onebeta.pdf',sep='')),width = 12, height = 24, units = "in")
  }
}
while(dev.cur()!=1) {dev.off()}
```

Repeat again with the smoothed beta densities instead of histograms.
```{r}
for (meas in opt$sensitivity_measure) {
  for (comp in names(onebeta.tibble.list)) {
    betadens <- onebeta.tibble.list[[comp]][[2]] %>%
      mutate(cross = paste(experiment, drug, sep='_')) %>%
      plyr::ddply(., "cross", function(df) {
      data.frame( 
        value = seq(.01, .99, length = 1000),
        beta_curve = dbeta(seq(.01, .99, length = 1000), 
                             df$param1, 
                             df$param2) 
      )
    })
    betadens <- as.tibble(betadens) %>% 
      separate(cross,into=c('experiment','drug'),sep='_') %>%
      group_by(experiment, drug) %>%
      #mutate(beta_curve = beta_curve / sum(beta_curve)) %>%
      ungroup() %>%
      filter(beta_curve>1e-5)
    onebeta.tibble.list[[comp]][[1]] %>%
      ggplot(aes(value)) +
        geom_density(adjust=.5,fill=1) +
        theme_minimal() + 
        facet_grid(cols = vars(experiment),rows=vars(drug), scales = 'free_y') + 
        theme(strip.text.x = element_text(size = 8), legend.position="none") + 
      scale_x_continuous(limits = c(0,1), name=meas) + 
      geom_line(data=betadens, aes(y = beta_curve), lwd = 1.5, color='blue')
    ggsave(file=file.path(opt$log_dir,meas,comp,paste('densities_smoothed_onebeta.pdf',sep='')),width = 12, height = 24, units = "in")
  }
}
while(dev.cur()!=1) {dev.off()}
```

Plot the beta model log likelihoods.
```{r}
for (meas in opt$sensitivity_measure) {
  for (comp in names(onebeta.tibble.list)) {
    combos <- t(combn(sort(unique(onebeta.tibble.list[[comp]][[1]]$experiment)),2))
    for (combo in 1:nrow(combos)) {
      onebeta.tibble.list[[comp]][[1]] %>% 
        filter(experiment %in% combos[combo,],
               measure == meas) %>%
        left_join(onebeta.tibble.list[[comp]][[2]], by=c('experiment','measure','drug')) %>%
        mutate(value = ifelse(value==0,1e-4,value)) %>%
        mutate(likelihood = dbeta(.$value,param1,param2)) %>%
        group_by(experiment, drug) %>% 
        summarise(loglik = sum(log(likelihood))/n()) %>%
        ungroup() %>%
        select(drug,experiment, loglik) %>%
        distinct() %>%
        spread(experiment,loglik) %>%
        ggplot(aes_string(x=combos[combo,1],
                          y=combos[combo,2],
                          label='drug')) + 
        geom_point(alpha=.8,size=1.5) + 
        geom_text_repel() + 
        theme_minimal() + 
        theme(strip.text.x = element_text(size = 8)) + 
        ggtitle('Beta average log likelihoods')
    ggsave(file=file.path(opt$log_dir,meas,comp,paste('logliks_',
                                            combos[combo,1],'_',combos[combo,2],
                                            '_onebeta.pdf',sep='')),
           width = 10, height = 10, units = "in")
    }
  }
}
```

Plot the pairwise concordance between two studies at a time with the posterior probability of agreement.
```{r}
for (meas in opt$sensitivity_measure) {
  for (comp in names(onebeta.tibble.list)) {
    combos <- t(combn(sort(unique(onebeta.tibble.list[[comp]][[1]]$experiment)),2))
    for (combo in 1:nrow(combos)) {
      onebeta.tibble.list[[comp]][[1]] %>%
        filter(experiment %in% combos[combo,],
               measure == meas) %>%
        group_by(drug, cell, measure) %>%
        mutate(agreement = prod(prob) + prod(1-prob)) %>% 
        ungroup() %>% 
        select(drug,cell,experiment, agreement, measure, everything()) %>%
        gather(variable, value, -(drug:measure)) %>% 
        unite(temp, experiment, variable) %>%
        spread(temp,value) %>%
        ggplot(aes_string(x=paste(combos[combo,1],'value',sep='_'),
                          y=paste(combos[combo,2],'value',sep='_'))) + 
        geom_point(aes(color=agreement),alpha=.8,size=2) + 
        scale_colour_gradient2(midpoint=.5,limits = c(0,1),mid='grey50') + 
        theme_minimal() + 
        facet_wrap(vars(drug),ncol=3) + 
        theme(strip.text.x = element_text(size = 8),
              legend.text=element_text(size=8),
              legend.title=element_text(size=0),
              legend.position='top') + 
        scale_x_continuous(breaks=c(0,.5,1),labels=c('0','0.5','1'),limits = c(0,1)) +
        scale_y_continuous(breaks=c(0,.5,1),labels=c('0','0.5','1'),limits = c(0,1))
    ggsave(file=file.path(opt$log_dir,meas,comp,paste('2way_agreement_',
                                            combos[combo,1],'_',combos[combo,2],
                                            '_onebeta.pdf',sep='')),
           width = 10, height = 18, units = "in")
    }
  }
}
```

### Model assignment

Select which drugs belong to which model from maximum average likelihood.
```{r, eval=FALSE}
rm(list=setdiff(ls(),c('onebeta.tibble.list','onenormal.tibble.list','twonormals.tibble.list','opt')))
for (meas in opt$sensitivity_measure) {
  for (comp in names(onebeta.tibble.list)) {
    onebeta.logliks <- onebeta.tibble.list[[comp]][[1]] %>% 
      filter(measure == meas) %>% 
      left_join(onebeta.tibble.list[[comp]][[2]], by=c('experiment','measure','drug')) %>%
      mutate(value = ifelse(value==0,1e-4,value)) %>%
      mutate(likelihood = dbeta(.$value,param1,param2)) %>%
      group_by(experiment, drug) %>% 
      summarise(loglik = sum(log(likelihood))/n()) %>%
      ungroup() %>%
      select(drug,experiment,loglik) %>%
      distinct() %>% 
      mutate(fit='onebeta')
    onenormal.logliks <- onenormal.tibble.list[[comp]][[1]] %>% 
      filter(measure == meas) %>% 
      left_join(onenormal.tibble.list[[comp]][[2]], by=c('experiment','measure','drug')) %>%
      mutate(value = ifelse(value==0,1e-4,value)) %>%
      mutate(likelihood = dnorm(.$value,param1,param2)) %>%
      group_by(experiment, drug) %>% 
      summarise(loglik = sum(log(likelihood))/n()) %>%
      ungroup() %>%
      select(drug,experiment,loglik) %>%
      distinct() %>% 
      mutate(fit='onenormal')
    logliks <- bind_rows(onebeta.logliks,onenormal.logliks) %>%
      group_by(drug, fit, experiment) %>%
      summarise(sumloglik = sum(loglik)) %>%
      arrange(desc(sumloglik)) %>%
      filter(row_number()==1) %>%
      ungroup()
  }
}
```


### Consistency comparison

Comparison with correlation measures of consistency.
```{r,eval=FALSE}
eval(parse(text=paste('lm1 <- lm(',opt$dataset2,'~',opt$dataset1,',data=sens.short)',sep='')))
  spear.corr <- cor(sens.short$CCLE,sens.short$GDSC,method='spearman')
  pear.corr <- cor(sens.short$CCLE,sens.short$GDSC,method='pearson')
  new_tibb <- bind_rows(new_tibb,tibble('drug'=dr,'LOR'=LOR,'Spearman'=spear.corr,'Pearson'=pear.corr))
  psens <-  sens.short %>%
    ggplot(aes_string(x=opt$dataset1,y=opt$dataset2)) + 
      theme_minimal() + 
      geom_point(size=3,alpha=.4) +
      theme(strip.text.x = element_text(size = 16),
            strip.text.y = element_text(size = 16),
            axis.text.x = element_text(size = 16),
            axis.text.y = element_text(size = 16),
            axis.title = element_text(size=18),
            plot.title = element_text(size=22),
            legend.text=element_text(size=8),
            legend.position="none",
            legend.title=element_text(size=10)) + 
      guides(color=guide_legend(title="Cell ID")) +
      ggtitle(dr) + 
      scale_x_continuous(breaks=c(0,.5,1),labels=c('0','0.5','1'),limits = c(0,1),expand = expand_scale(add=c(.02, 0))) +
      scale_y_continuous(breaks=c(0,.5,1),labels=c('0','0.5','1'),limits = c(0,1),expand = expand_scale(add=c(.02, 0)))
  ggsave(file=file.path(opt$log_dir,opt$sensitivity_measure,'by_drug', 'pairwise', paste(dr,'.png',sep='')),width = 8, height = 8, units = "in")
  psens + 
      geom_label(aes(x = .025, y = .9, label = paste('Pearson:',round(pear.corr,2),sep=' ')), fill = "white",hjust = 0,vjust=0,label.size=0,size=4.5) +
      geom_label(aes(x = .025, y = .84, label = paste('Spearman:',round(spear.corr,2),sep=' ')), fill = "white",hjust = 0,vjust=0,label.size=0,size=4.5) +
      #geom_abline(intercept=0,slope=1,size=.3,color='grey20',lty=1) #+
      geom_smooth(method='lm',se=FALSE,color='grey20',size=.3,lty=2,fullrange=TRUE) 
  ggsave(file=file.path(opt$log_dir,opt$sensitivity_measure,'by_drug', 'pairwise', paste(dr,'_wCorr.png',sep='')),width = 8, height = 8, units = "in")
  psens <- psens + 
      geom_vline(xintercept=.3,size=.5,color='grey20',lty=3) +
      geom_hline(yintercept=.3,size=.5,color='grey20',lty=3) +
    geom_label(aes(x = .025, y = .9, label = paste('Log OR:',round(LOR,2),sep=' ')), fill = "white",hjust = 0,vjust=0,label.size=0,size=4.5) +
    geom_point(aes(color=ifelse(agree & CCLE>.3,TRUE,FALSE)),size=3,alpha=.4,show.legend = FALSE) + 
    scale_color_manual(values=c("#999999", "blue"))
  ggsave(file=file.path(opt$log_dir,opt$sensitivity_measure,'by_drug', 'pairwise', paste(dr,'_wLO.png',sep='')),width = 8, height = 8, units = "in")
while(dev.cur()!=1) {dev.off()}
```

Plot the measures of consistency for all pairwise comparisons (log-odds versus spearman rank and pearson).
```{r,eval=FALSE}
new_tibb %>% 
  mutate(label=ifelse(LOR>2,drug,'')) %>%
  ggplot(aes(x=Spearman,y=Pearson,label=label)) +
  geom_point() +
  geom_text_repel() + 
  theme_minimal() + 
  theme(strip.text.x = element_text(size = 16),
          strip.text.y = element_text(size = 16),
          axis.text.x = element_text(size = 16),
          axis.text.y = element_text(size = 16),
          axis.title = element_text(size=18),
          plot.title = element_text(size=22),
          legend.text=element_text(size=8),
          legend.position="none",
          legend.title=element_text(size=10)) + 
    scale_x_continuous(breaks=c(-1,-.5,0,.5,1),labels=c('-1','-0.5','0','0.5','1'),limits = c(-1,1)) + 
    scale_y_continuous(breaks=c(0,.5,1),labels=c('0','0.5','1'),limits = c(0,1)) + 
    geom_vline(xintercept=0,size=.5,color='grey20',lty=3) + 
    geom_hline(yintercept=0,size=.5,color='grey20',lty=3)
ggsave(file=file.path(opt$log_dir,opt$sensitivity_measure,'pear_v_spear.png'),width = 8, height = 8,units='in')

new_tibb %>% 
  mutate(label=ifelse(LOR>2 ,drug,'')) %>%
  ggplot(aes(x=Spearman,y=LOR,label=label)) +
  geom_point() +
  geom_text_repel() + 
  theme_minimal() +
  theme(strip.text.x = element_text(size = 16),
          strip.text.y = element_text(size = 16),
          axis.text.x = element_text(size = 16),
          axis.text.y = element_text(size = 16),
          axis.title = element_text(size=18),
          plot.title = element_text(size=22),
          legend.text=element_text(size=8),
          legend.position="none",
          legend.title=element_text(size=10)) + 
    scale_x_continuous(breaks=c(-1,-.5,0,.5,1),labels=c('-1','-0.5','0','0.5','1'),limits = c(-1,1)) + 
    geom_vline(xintercept=0,size=.5,color='grey20',lty=3) 
ggsave(file=file.path(opt$log_dir,opt$sensitivity_measure,'OR_v_spear.png'),width = 8, height = 8,units='in')

new_tibb %>% 
  mutate(label=ifelse(LOR>2 ,drug,'')) %>%
  ggplot(aes(x=Pearson,y=LOR,label=label)) +
  geom_point() +
  geom_text_repel() + 
  theme_minimal() +
  theme(strip.text.x = element_text(size = 16),
          strip.text.y = element_text(size = 16),
          axis.text.x = element_text(size = 16),
          axis.text.y = element_text(size = 16),
          axis.title = element_text(size=18),
          plot.title = element_text(size=22),
          legend.text=element_text(size=8),
          legend.position="none",
          legend.title=element_text(size=10)) + 
    scale_x_continuous(breaks=c(0,.5,1),labels=c('0','0.5','1'),limits = c(0,1)) + 
    geom_vline(xintercept=0,size=.5,color='grey20',lty=3) 
ggsave(file=file.path(opt$log_dir,opt$sensitivity_measure,'OR_v_pear.png'),width = 8, height = 8,units='in')
```
