---
title: "Estimate posterior concordance"
author: "Matt Ploenzke"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Estimate concordance}
  %\VignetteEngine{knitr::rmarkdown}
  \usepackage[utf8]{inputenc}
---

Set up and load packages.
```{r setup, include=FALSE}
  rm(list=ls(all=TRUE))
  knitr::opts_chunk$set(echo = TRUE)
  library(concordResponse)
  library(tidyverse)
  library(ggridges)
```

Set options.
```{r}
  opt <- list()
  opt$datasets <- c('CCLE','GDSC','gCSI','FIMM') # CCLE GDSC GDSC1000 gCSI FIMM
  opt$min_intersection <- 2 # Minimum number of studies a drug/cell must be assayed in to be included in the intersection comparison
  opt$log_dir <- paste(paste(opt$datasets,collapse='_'),'fit_eb',sep='_')
  opt$sensitivity_measure <- c('auc_recomputed') # raw_auc e_inf hill_slope ec50 auc_recomputed
  opt$use_small_datasets <- FALSE
  # Prior specifications denoting cell sensitivity and proportion of drugs broadly-active:
  opt$prior.sensitive <- .3 # prior specification denoting cell is sensitive if greater than this value
  opt$prior.broadly.active <- .05 # prior specification denoting drug is broadly-active if probability cell is sensitive is greater than value
  opt$level.one.flat.prior <- FALSE # should assignments using these \thresholds be random? 
  opt$level.two.empirical <- TRUE # should prior distributions for drug types and individual drugs be fit empirically? 
  # If level.two.empirical is FALSE, then specify params below: 
  opt$targeted.alpha.prior <- 1 # prior for alpha in beta distribution for targeted drug probability of sensitivity
  opt$targeted.beta.prior <- 10 # prior for beta in beta distribution for targeted drug probability of sensitivity
  opt$broad.alpha.prior <- 1 # prior for alpha in beta distribution for broadly-active drug probability of sensitivity
  opt$broad.beta.prior <- 1 # prior for beta in beta distribution for broadly-active drug probability of sensitivity
  opt$resistant.alpha.prior <- 1 # prior for alpha in beta distribution of cell sensitivity for resistant cells in targeted drugs
  opt$resistant.beta.prior <- 10 # prior for beta in beta distribution of cell sensitivity for resistant cells in targeted drugs
  opt$sensitive.alpha.prior <- 1 # prior for alpha in beta distribution of cell sensitivity for sensitive cells in targeted drugs
  opt$sensitive.beta.prior <- 1 # prior for beta in beta distribution of cell sensitivity for sensitivfe cells in targeted drugs
```

Set up log directory.
```{r}
  dir.create(opt$log_dir,showWarnings = FALSE)
  capture.output(opt, file = file.path(opt$log_dir,'model_Opts.csv'))
```

First download the full datasets.
```{r,eval=FALSE}
  PharmacoGx::availablePSets()
  for (dataset in opt$datasets) {
    PharmacoGx::downloadPSet(dataset)
  }
```

Load data.
```{r}
  for (dataset in opt$datasets) {
    load(file.path('../PSets',paste(dataset,'RData',sep='.')))
  }
  if (opt$use_small_datasets) {
    CCLE <- PharmacoGx::CCLEsmall
    GDSC <- PharmacoGx::GDSCsmall
  }
```

Format the sensitivity data for each experiment. Find cells and drugs assayed across experiment. Remove noisy experiments and mislabelled cell lines. Calculate sensitivity measures per cell/drug.
```{r}
  sensitivity.tibble.list <- intersectPSetWrapper(datasets = opt$datasets,
                                                  minimum_intersection = 1,
                                                  intersectOn = c('cell.lines','drugs'),
                                                  sensitivity_measure = opt$sensitivity_measure,
                                                  remove_noisy_curves = FALSE,
                                                  remove_mislabelled_cells = FALSE)
```

Repeat but for the intersection.
```{r}
  intersection.tibble.list <- intersectPSetWrapper(datasets = opt$datasets,
                                                  minimum_intersection = opt$min_intersection,
                                                  intersectOn = c('cell.lines','drugs'),
                                                  sensitivity_measure = opt$sensitivity_measure,
                                                  remove_noisy_curves = FALSE,
                                                  remove_mislabelled_cells = FALSE)
  eval(parse(text=paste('rm(',paste(opt$datasets,collapse=','),')',sep='')))
```

Plot the distribution of each measure for the intersection.
```{r}
  for (meas in opt$sensitivity_measure) {
    dir.create(file.path(opt$log_dir,meas),showWarnings = FALSE)
    for (comp in names(intersection.tibble.list)) {
      dir.create(file.path(opt$log_dir,meas,comp),showWarnings = FALSE)
      p <- intersection.tibble.list[[comp]] %>%
        filter(measure==meas) %>%
        ggplot(aes(value)) +
          stat_bin(bins=50) + 
          theme_bw() + 
          facet_grid(cols = vars(experiment),rows=vars(drug), scales = 'free_y') + 
          theme(strip.text.x = element_text(size = 12),
            legend.position='none',
            axis.text=element_text(size=12),
            axis.title=element_text(size=12),
            legend.text=element_text(size=12),
            legend.title=element_text(size=12),
            title=element_text(size=14)) +  
        theme(strip.text.x = element_text(size = 8), legend.position="none") + 
          scale_x_continuous(name = meas) 
      ggsave(p,file=file.path(opt$log_dir,meas,comp,paste('densities_raw.pdf',sep='')),width = 12, height = 24, units = "in")
      saveRDS(p, file.path(opt$log_dir,meas,comp,paste('densities_raw.RDS',sep='')))
      p <- intersection.tibble.list[[comp]] %>%
        filter(measure==meas) %>%
        mutate(drug=as.factor(drug)) %>% 
        mutate(drug=reorder(drug, value, mean)) %>%
        ggplot(aes(x=value,y=drug,fill=experiment)) +
        geom_density_ridges(alpha = .2) + 
        scale_x_continuous(limits = c(0,1)) + 
        theme_bw() +  scale_fill_brewer(palette="Dark2") +
        theme(axis.title.y = element_blank(), axis.title.x = element_blank()) + 
        theme(strip.text.x = element_text(size = 14),
              legend.text=element_text(size=14),
              legend.title=element_text(size=14),
              legend.position="none",
              axis.text=element_text(size=12),
              axis.title = element_text(size=14),
              plot.title = element_text(size = 16)) 
        ggsave(p,file=file.path(opt$log_dir,meas,comp,paste('smoothed_densities_raw.pdf',sep='')),width = 12, height = 24, units = "in")
        saveRDS(p, file = file.path(opt$log_dir,meas,comp,paste('smoothed_densities_raw.RDS',sep='')))
    }
   p <- intersection.tibble.list[[comp]] %>%
        filter(measure==meas) %>%
        mutate(drug=as.factor(drug)) %>% 
        mutate(drug=reorder(drug, value, mean)) %>%
        ggplot(aes(y=value,x=drug)) +
          geom_boxplot() + 
          theme_bw() + 
          facet_wrap(vars(experiment), scales = 'free_x',ncol=1) + 
            theme(strip.text.x = element_text(size = 18),
            axis.text.x = element_text(angle = 45, hjust = 1),
            legend.position='none',
            axis.text=element_text(size=16),
            axis.title=element_text(size=18),
            legend.text=element_text(size=12),
            legend.title=element_text(size=12),
            title=element_text(size=14)) + 
            scale_y_continuous(breaks=c(0,1)) +
            labs(x="Drug",y=meas)
      ggsave(p,file=file.path(opt$log_dir,meas,comp,paste('boxplot_raw_common_drugs.pdf',sep='')),width = 12, height = 8, units = "in",limitsize=FALSE)
      saveRDS(p, file.path(opt$log_dir,meas,comp,paste('boxplot_raw_common_drugs.RDS',sep='')))
  }
  while(dev.cur()!=1) {dev.off()}
  common.drugs <- lapply(names(intersection.tibble.list), function(comp) {
    intersection.tibble.list[[comp]] %>%
      distinct(drug) %>% 
      pull()
  })
  names(common.drugs) <- names(intersection.tibble.list)
  for (meas in opt$sensitivity_measure) {
    for (comp in names(intersection.tibble.list)) {
      p <- sensitivity.tibble.list[strsplit(comp,split='_')[[1]]] %>%
        bind_rows() %>%
        filter(measure==meas, drug %in% common.drugs[[comp]]) %>%
        mutate(drug=as.factor(drug)) %>% 
        mutate(drug=reorder(drug, value, mean)) %>%
        ggplot(aes(y=value,x=drug,fill=experiment)) +
          geom_boxplot() + 
          theme_bw() + 
          #facet_wrap(vars(experiment), scales = 'free_x',ncol=1) + 
            theme(strip.text.x = element_text(size = 18),
            legend.position='none',
            axis.text=element_text(size=12),
            axis.text.y=element_text(size=16),
            axis.title=element_text(size=18),
            legend.text=element_text(size=12),
            axis.text.x = element_text(angle = 45, hjust = 1),
            legend.title=element_text(size=12),
            title=element_text(size=14)) + 
            scale_y_continuous(breaks=c(0,1)) +
            labs(x="Drug",y=NULL)
      ggsave(p,file=file.path(opt$log_dir,meas,comp,paste('boxplot_raw_all_cells.pdf',sep='')),width = 12, height = 8, units = "in",limitsize=FALSE)
      saveRDS(p, file=file.path(opt$log_dir,meas,comp,paste('boxplot_raw_all_cells.RDS',sep='')))
      maxdr <- sensitivity.tibble.list[strsplit(comp,split='_')[[1]]] %>%
        bind_rows() %>%
        filter(measure==meas, drug %in% common.drugs[[comp]]) %>%
        summarise(max(nchar(drug))) %>%
        pull()
      p <- sensitivity.tibble.list[strsplit(comp,split='_')[[1]]] %>%
        bind_rows() %>%
        filter(measure==meas) %>%
        mutate(color = ifelse(drug %in% common.drugs[[comp]],'blue','grey')) %>%
        mutate(drug=as.factor(drug),color=as.factor(color)) %>% 
        mutate(drug=reorder(drug, value, mean)) %>%
        ggplot(aes(y=value,x=drug)) +
          geom_boxplot(aes(color=color),show.legend=FALSE) + 
          theme_bw() + 
          facet_wrap(vars(experiment), scales = 'free_x',ncol=1) + 
            theme(strip.text.x = element_text(size = 18),
            legend.position='none',
            axis.text=element_text(size=16),
            axis.text.x =element_text(colour = 'white',angle = 45, hjust = 1,size=8),
            axis.title=element_text(size=18),
            legend.text=element_text(size=12),
            legend.title=element_text(size=12),
            title=element_text(size=14)) + 
            labs(x="Drug",y=meas) + 
            scale_y_continuous(breaks=c(0,1)) +
            scale_color_manual(values=c('black','grey50')) 
      ggsave(p,file=file.path(opt$log_dir,meas,comp,paste('boxplot_raw_all_drugs.pdf',sep='')),width = 12, height = 8, units = "in",limitsize=FALSE)
      saveRDS(p, file=file.path(opt$log_dir,meas,comp,paste('boxplot_raw_all_drugs.RDS',sep='')))
    }
  }
```

Repeat for individual studies.
```{r}
  for (meas in opt$sensitivity_measure) {
    dir.create(file.path(opt$log_dir,meas),showWarnings = FALSE)
    for (comp in names(sensitivity.tibble.list)) {
      dir.create(file.path(opt$log_dir,meas,comp),showWarnings = FALSE)
      num_drug <- length(unique(sensitivity.tibble.list[[comp]]$drug))
      p <- sensitivity.tibble.list[[comp]] %>%
        filter(measure==meas) %>%
        ggplot(aes(value)) +
          stat_bin(bins=50) + 
          theme_bw() + 
          facet_wrap(vars(drug), scales = 'free_y',ncol=3) + 
            theme(strip.text.x = element_text(size = 12),
            legend.position='none',
            axis.text=element_text(size=12),
            axis.title=element_text(size=12),
            legend.text=element_text(size=12),
            legend.title=element_text(size=12),
            title=element_text(size=14)) +
          coord_cartesian(xlim = c(0, 1)) +
          scale_x_continuous(name = meas) 
      ggsave(p,file=file.path(opt$log_dir,meas,comp,paste('densities_raw.pdf',sep='')),width = 12, height = num_drug, units = "in",limitsize=FALSE)
      saveRDS(p,file=file.path(opt$log_dir,meas,comp,paste('densities_raw.RDS',sep='')))
    }
  }
  while(dev.cur()!=1) {dev.off()}
```

Plot the pairwise concordance between two studies at a time.
```{r}
  for (meas in opt$sensitivity_measure) {
    for (comp in names(intersection.tibble.list)) {
      combos <- t(combn(sort(unique(intersection.tibble.list[[comp]]$experiment)),2))
      for (combo in 1:nrow(combos)) {
        p <- intersection.tibble.list[[comp]] %>%
          filter(experiment %in% combos[combo,],
                 measure == meas) %>%
          select(drug,cell,experiment, measure, everything()) %>%
          gather(variable, value, -(drug:measure)) %>% 
          unite(temp, experiment, variable) %>%
          spread(temp,value) %>%
          ggplot(aes_string(x=paste(combos[combo,1],'value',sep='_'),
                            y=paste(combos[combo,2],'value',sep='_'))) + 
          geom_point(alpha=.15,size=1.5) + 
          scale_color_brewer(palette = 'Dark2') + 
          geom_abline(slope=1, size=.5,color='black', lty=3) + 
          theme_bw() + 
          facet_wrap(vars(drug),ncol=5) + 
          theme(strip.text.x = element_text(size = 12),
            legend.position='top',
            axis.text=element_text(size=12),
            axis.title=element_text(size=12),
            legend.text=element_text(size=12),
            legend.title=element_text(size=0),
            title=element_text(size=14)) +
          scale_x_continuous(breaks=c(0,.5,1),labels=c('0','0.5','1'),limits = c(0,1)) +
          scale_y_continuous(breaks=c(0,.5,1),labels=c('0','0.5','1'),limits = c(0,1))
      ggsave(p,file=file.path(opt$log_dir,meas,comp,paste('2way_',
                                              combos[combo,1],'_',combos[combo,2],
                                              '.pdf',sep='')),
             width = 18, height = 10, units = "in")
      saveRDS(p,file=file.path(opt$log_dir,meas,comp,paste('2way_',
                                              combos[combo,1],'_',combos[combo,2],
                                              '.RDS',sep='')))
      }
    }
  }
```

Functions to calculate the MLEs.
```{r}
  library(VGAM)
  fit_bb_mle <- function(x, n) {
    ll <- function(alpha, beta) {
      -sum(dbetabinom.ab(x, n, alpha, beta, log = TRUE))
    }
    m <- try({
      stats4::mle(ll, start = list(alpha = 3, beta = 10), method = "L-BFGS-B",
                     lower = c(0.001, .001))
    }, silent=TRUE)
    if (class(m) == "try-error") {
      ab <- c(1e-2,1e-2)
    } else {
      ab <- stats4::coef(m)
    }
    data_frame(alpha = ab[1], beta = ab[2], number = length(x))
  }
  fit_beta_mle <- function(x) {
    ll <- function(alpha, beta) {
      -sum(dbeta(x, alpha, beta, log = TRUE))
    }
    m <- stats4::mle(ll, start = list(alpha = 3, beta = 10), method = "L-BFGS-B",
                     lower = c(0.001, .001))
    ab <- stats4::coef(m)
    data_frame(alpha = ab[1], beta = ab[2], number = length(x))
  }
```

Initialize drug and cell assignments for EM using prior specifications for probability sensitive and probability drug is broadly active. Or use a flat prior (random initialization).
```{r}
  if (opt$level.one.flat.prior) {
    drugs.tibble.list <- lapply(sensitivity.tibble.list, function(li) {
      li %>% 
        mutate(sensitive = ifelse(value > opt$prior.sensitive, 1,0)) %>%
        group_by(drug, measure) %>%
        summarise(p_prior = mean(sensitive),
                  sensitive = sum(sensitive),
                  cell_count = n()) %>%
        ungroup() %>% 
        mutate(drug_type = ifelse(runif(n(),0,1)>opt$prior.broadly.active,'broad','targeted'))
    })
    cells.tibble.list <- lapply(1:length(sensitivity.tibble.list), function(li) {
      sensitivity.tibble.list[[li]] %>% 
        left_join(drugs.tibble.list[[li]], by=c('drug','measure')) %>% 
        select(drug:measure,drug_type) %>%
        mutate(cell_type = ifelse(drug_type=='broad',ifelse(runif(n(),0,1)>1,'sensitive','resistant'),
                                  ifelse(runif(n(),0,1)>opt$prior.sensitive,'sensitive','resistant')))
    })
  } else {
    drugs.tibble.list <- lapply(sensitivity.tibble.list, function(li) {
      li %>% 
        mutate(sensitive = ifelse(value > opt$prior.sensitive, 1,0)) %>%
        group_by(drug, measure) %>%
        summarise(p_prior = mean(sensitive),
                  sensitive = sum(sensitive),
                  cell_count = n()) %>%
        ungroup() %>% 
        mutate(drug_type = ifelse(p_prior>opt$prior.broadly.active,'broad','targeted'))
    })
    cells.tibble.list <- lapply(1:length(sensitivity.tibble.list), function(li) {
      sensitivity.tibble.list[[li]] %>% 
        left_join(drugs.tibble.list[[li]], by=c('drug','measure')) %>% 
        select(drug:measure,drug_type) %>%
        mutate(cell_type = ifelse(drug_type=='broad',ifelse(value>1,'sensitive','resistant'),
                                  ifelse(value>opt$prior.sensitive,'sensitive','resistant')))
    })
  }
  names(cells.tibble.list) <- names(drugs.tibble.list)
```

Plot these.
```{r}
  for (meas in opt$sensitivity_measure) {
    for (comp in names(sensitivity.tibble.list)) {
      p <- drugs.tibble.list[[comp]] %>%
        filter(measure==meas) %>%
        ggplot(aes(p_prior)) +
          stat_bin(bins=50) + 
          theme_bw() + 
          theme(strip.text.x = element_text(size = 12),
            legend.position='none',
            axis.text=element_text(size=12),
            axis.title=element_text(size=12),
            legend.text=element_text(size=12),
            legend.title=element_text(size=12),
            title=element_text(size=14)) +
          coord_cartesian(xlim = c(0, 1)) +
          scale_x_continuous(name = 'p_prior') 
      ggsave(p, file=file.path(opt$log_dir,meas,comp,paste('p_prior.pdf',sep='')),width = 4, height = 4, units = "in",limitsize=FALSE)
      saveRDS(p, file=file.path(opt$log_dir,meas,comp,paste('p_prior.RDS',sep='')))
    }
  }
  for (meas in opt$sensitivity_measure) {
    for (comp in names(intersection.tibble.list)) {
      p <-  cells.tibble.list[strsplit(comp,split='_')[[1]]] %>%
        bind_rows() %>%
        filter(measure==meas, drug %in% common.drugs[[comp]]) %>%
        mutate(drug=as.factor(drug)) %>% 
        mutate(drug=reorder(drug, value, mean)) %>%
        ggplot(aes(y=value,x=drug,fill=as.factor(drug_type))) +
          geom_boxplot() + 
          theme_bw() + 
          facet_wrap(vars(experiment), scales = 'free_x',ncol=1) + 
            theme(strip.text.x = element_text(size = 18),
            legend.position='bottom',
            axis.text=element_text(size=12),
            axis.text.y=element_text(size=16),
            axis.title=element_text(size=18),
            legend.text=element_text(size=12),
            axis.text.x = element_text(angle = 45, hjust = 1),
            legend.title=element_text(size=12),
            title=element_text(size=14)) + 
            scale_y_continuous(breaks=c(0,1)) +
            labs(x="Drug",y=NULL)
      ggsave(p,file=file.path(opt$log_dir,meas,comp,paste('boxplot_raw_all_cells_prior.pdf',sep='')),width = 12, height = 8, units = "in",limitsize=FALSE)
      saveRDS(p, file=file.path(opt$log_dir,meas,comp,paste('boxplot_raw_all_cells_prior.RDS',sep='')))
      maxdr <- sensitivity.tibble.list[strsplit(comp,split='_')[[1]]] %>%
        bind_rows() %>%
        filter(measure==meas, drug %in% common.drugs[[comp]]) %>%
        summarise(max(nchar(drug))) %>%
        pull()
      p <- cells.tibble.list[strsplit(comp,split='_')[[1]]] %>%
        bind_rows() %>%
        filter(measure==meas) %>%
        mutate(color = ifelse(drug %in% common.drugs[[comp]],'blue','grey')) %>%
        mutate(drug=as.factor(drug),color=as.factor(color)) %>% 
        mutate(drug=reorder(drug, value, mean)) %>%
        ggplot(aes(y=value,x=drug)) +
          geom_boxplot(aes(color=color, fill=as.factor(drug_type)),show.legend=FALSE) + 
          theme_bw() + 
          facet_wrap(vars(experiment), scales = 'free_x',ncol=1) + 
            theme(strip.text.x = element_text(size = 18),
            legend.position='bottom',
            axis.text=element_text(size=16),
            axis.text.x =element_text(colour = 'white',angle = 45, hjust = 1,size=8),
            axis.title=element_text(size=18),
            legend.text=element_text(size=12),
            legend.title=element_text(size=12),
            title=element_text(size=14)) + 
            labs(x="Drug",y=meas) + 
            scale_y_continuous(breaks=c(0,1)) +
            scale_color_manual(values=c('black','grey50')) 
      ggsave(p,file=file.path(opt$log_dir,meas,comp,paste('boxplot_raw_all_drugs_prior.pdf',sep='')),width = 12, height = 8, units = "in",limitsize=FALSE)
      saveRDS(p, file=file.path(opt$log_dir,meas,comp,paste('boxplot_raw_all_drugs_prior.RDS',sep='')))
    }
  }
```

Smoothed density of the prior pi across all studies.
```{r}
  for (meas in opt$sensitivity_measure) {
    temptibb <- tibble()
    for (comp in names(sensitivity.tibble.list)) {
      temptibb <- drugs.tibble.list[[comp]] %>%
        filter(measure==meas) %>%
        mutate(experiment=comp) %>%
        bind_rows(temptibb)
    }
    p <- temptibb %>% 
      ggplot(aes(x=p_prior,fill='one',y=..scaled..)) +
        geom_density(alpha = .5) + 
        theme_bw() +  
        facet_wrap(vars(experiment),nrow=2) +
        scale_fill_brewer(palette="Dark2") +
        theme(strip.text.x = element_text(size = 14),
              legend.text=element_text(size=14),
              legend.title=element_text(size=14),
              legend.position="none",
              axis.text=element_text(size=12),
              axis.title = element_text(size=14),
              plot.title = element_text(size = 16)) +
        scale_x_continuous(breaks=c(0,.5,1),labels=c('0','0.5','1'),limits = c(0,1),name=expression(paste(p, '(',pi, ")",sep=''))) +
        scale_y_continuous(breaks=c(0,1),labels=c('0','1'),limits = c(0,1), name='Density')
    ggsave(p, file=file.path(opt$log_dir,meas,paste('p_prior_smoothed.pdf',sep='')),width = 4, height = 4, units = "in",limitsize=FALSE)
    saveRDS(p, file=file.path(opt$log_dir,meas,paste('p_prior_smoothed.RDS',sep='')))
  }
```

EM function definition.
```{r}
  library(purrr)
  iterate_em <- function(state, ...) {
    # M-step for drug-type parameters
    drug_types <- state$drug_assignments %>%
      group_by(drug_type) %>%
      do(mutate(fit_bb_mle(.$sensitive, .$cell_count), number = nrow(.))) %>%
      ungroup() %>%
      mutate(prior = number / sum(number))
    
    # E-step for drug types
    drug_assignments <- drug_assignments %>%
      select(drug:cell_count) %>%
      crossing(drug_types) %>%
      mutate(likelihood = prior * VGAM::dbetabinom.ab(sensitive, cell_count, alpha, beta)) %>%
      group_by(drug) %>%
      mutate(posterior=likelihood/sum(likelihood)) %>%
      top_n(1, likelihood) %>%
      ungroup()
    
    # M-step for drug-specific parameters (targetted)
    targetted_drug_fits_temp <- state$cell_assignments %>%
      mutate(x=round(value*1e3),n=1e3) %>%
      select(-drug_type) %>%
      left_join(drug_assignments %>% select(drug,drug_type), by='drug') %>%
      filter(drug_type == 'targeted') %>%
      group_by(drug, cell_type, drug_type) %>%
      do(mutate(fit_bb_mle(.$x, .$n),number = nrow(.))) %>%
      group_by(drug) %>%
      mutate(ndist=n_distinct(cell_type)) %>%
      ungroup()
    targetted_drug_fits <- targetted_drug_fits_temp %>%
        bind_rows(
          targetted_drug_fits_temp %>% 
            filter(ndist<2) %>% 
            mutate(cell_type2 = case_when(cell_type=='resistant' ~ 'sensitive',cell_type=='sensitive' ~ 'resistant'),
                   cell_type=cell_type2,
                   number=0,
                   alpha=case_when(cell_type == 'resistant' ~ opt$resistant.alpha.prior,
                                   cell_type == 'sensitive' ~ opt$sensitive.alpha.prior),
                   beta=case_when(cell_type == 'resistant' ~ opt$resistant.beta.prior,
                                  cell_type == 'sensitive' ~ opt$sensitive.beta.prior)) %>%
            select(-cell_type2)
        ) %>%
        group_by(drug) %>%       
        mutate(prior = number / sum(number)) %>%
        ungroup() %>% 
        select(-ndist)
    
    # M-step for drug-specific parameters (broad)
    broad_drug_fits <- state$cell_assignments %>%
      mutate(x=ifelse(value==0,1e-3,value)) %>%
      select(-drug_type) %>%
      left_join(drug_assignments %>% select(drug,drug_type), by='drug') %>%
      filter(drug_type == 'broad') %>%
      group_by(drug, drug_type) %>%
      do(mutate(fit_beta_mle(.$x),number = nrow(.))) %>%
      ungroup() %>%
      mutate(prior = 1)
    drug_fits <- bind_rows(targetted_drug_fits,broad_drug_fits)
    
    # E-step for cell types (targetted drugs)
    targetted_drug_list <- unique(targetted_drug_fits$drug)
    targetted_cell_assignments <- lapply(targetted_drug_list, function(dr) {
      cell_assignments %>%
        filter(drug == dr) %>%
        select(drug:drug_type) %>%
        mutate(drug_type='targeted') %>%
        mutate(x=round(value*1e3),n=1e3) %>%
        crossing(targetted_drug_fits %>% filter(drug == dr) %>% select(-drug, -drug_type)) %>%
        mutate(likelihood = prior * VGAM::dbetabinom.ab(x, n, alpha, beta)) %>%
        group_by(drug, cell) %>%
        mutate(posterior=likelihood/sum(likelihood)) %>%
        top_n(1, likelihood) %>%
        ungroup()
    })
    targetted_cell_assignments <- do.call(bind_rows, targetted_cell_assignments)
    
    # E-step for cell types (broad drugs)
    broad_drug_list <- unique(broad_drug_fits$drug)
    broad_cell_assignments <- cell_assignments %>%
        filter(drug %in% broad_drug_list) %>%
        select(drug:drug_type) %>%
      mutate(drug_type='broad') %>%  
      mutate(x=ifelse(value==0,1e-3,value)) %>%
        left_join(broad_drug_fits, by=c('drug','drug_type')) %>%
        mutate(likelihood = 1 * dbeta(x, alpha, beta),
               x=x*1e3,n=1e3,cell_type = ifelse(value>=qbeta(.95,.$alpha,.$beta),'sensitive','resistant'),
               posterior = pbeta(.$value,.$alpha,.$beta,lower.tail = FALSE))
    cell_assignments <- bind_rows(targetted_cell_assignments,broad_cell_assignments)
    
    list(drug_assignments = drug_assignments,
         drug_types = drug_types,
         cell_assignments = cell_assignments,
         drug_fits = drug_fits)
  }
```

Using the assignments, fit distributions (first M step) and use these as priors to initialize EM with. Alternatively, use prior specification for all drug parameters.
```{r}
  meas <- opt$sensitivity_measure[1]  
  if (opt$level.two.empirical) {
    drug_types_list <- lapply(drugs.tibble.list, function(tibb) {
      tibb %>%
        filter(measure==meas) %>%
        group_by(drug_type) %>%
        do(mutate(fit_bb_mle(.$sensitive, .$cell_count), number = nrow(.))) %>%
        ungroup() %>%
        mutate(prior = number / sum(number))
    })
    targetted_drug_fits_list <- lapply(cells.tibble.list, function(tibb) {
      ttibb <- tibb %>%
        filter(measure==meas) %>%
        mutate(x=round(value*1e3),n=1e3) %>%
        filter(drug_type == 'targeted') %>%
        group_by(drug, cell_type, drug_type) %>%
        do(mutate(fit_bb_mle(.$x, .$n),number = nrow(.))) %>%
        group_by(drug) %>%
        mutate(ndist=n_distinct(cell_type)) %>%
        ungroup()
      ttibb %>%
        bind_rows(
          ttibb %>% 
            filter(ndist<2) %>% 
            mutate(cell_type2 = case_when(cell_type=='resistant' ~ 'sensitive',cell_type=='sensitive' ~ 'resistant'),
                   cell_type=cell_type2,
                   number=0,
                   alpha=case_when(cell_type == 'resistant' ~ opt$resistant.alpha.prior,
                                   cell_type == 'sensitive' ~ opt$sensitive.alpha.prior),
                   beta=case_when(cell_type == 'resistant' ~ opt$resistant.beta.prior,
                                  cell_type == 'sensitive' ~ opt$sensitive.beta.prior)) %>%
            select(-cell_type2)
        ) %>%
        group_by(drug) %>%       
        mutate(prior = number / sum(number)) %>%
        ungroup() %>% 
        select(-ndist)
    })
    broad_drug_fits_list <- lapply(cells.tibble.list, function(tibb) {
      tibb %>%
        filter(measure==meas) %>%
        mutate(x=ifelse(value==0,1e-2,value)) %>%
        filter(drug_type == 'broad') %>%
        group_by(drug, drug_type) %>%
        do(mutate(fit_beta_mle(.$x),number = nrow(.))) %>%
        ungroup() %>% 
        mutate(prior = .05)
    })
  } else {
    drug_types_list <- lapply(drugs.tibble.list, function(tibb) {
      tibb %>%
        filter(measure==meas) %>%
        group_by(drug_type) %>%
        do(mutate(fit_bb_mle(.$sensitive, .$cell_count), number = nrow(.))) %>%
        ungroup() %>%
        mutate(alpha=case_when(drug_type=='targeted' ~ opt$targeted.alpha.prior,
                               drug_type=='broad' ~ opt$broad.alpha.prior),
               beta=case_when(drug_type=='targeted' ~ opt$targeted.beta.prior,
                               drug_type=='broad' ~ opt$broad.beta.prior)) %>%
        mutate(prior = number / sum(number))
    })
    targetted_drug_fits_list <- lapply(cells.tibble.list, function(tibb) {
      ttibb <- tibb %>%
        filter(measure==meas) %>%
        mutate(x=round(value*1e3),n=1e3) %>%
        filter(drug_type == 'targeted') %>%
        group_by(drug, cell_type, drug_type) %>%
        do(mutate(fit_bb_mle(.$x, .$n),number = nrow(.))) %>%
        group_by(drug) %>%
        mutate(ndist=n_distinct(cell_type)) %>%
        ungroup()
      ttibb %>%
        bind_rows(
          ttibb %>% 
            filter(ndist<2) %>% 
            mutate(cell_type2 = case_when(cell_type=='resistant' ~ 'sensitive',cell_type=='sensitive' ~ 'resistant'),
                   cell_type=cell_type2,
                   number=0) %>%
            select(-cell_type2)
        ) %>%
        group_by(drug) %>%       
        mutate(alpha=case_when(cell_type == 'resistant' ~ opt$resistant.alpha.prior,
                               cell_type == 'sensitive' ~ opt$sensitive.alpha.prior),
               beta=case_when(cell_type == 'resistant' ~ opt$resistant.beta.prior,
                              cell_type == 'sensitive' ~ opt$sensitive.beta.prior)) %>%
        mutate(prior = number / sum(number)) %>%
        ungroup() %>% 
        select(-ndist)
    })
    broad_drug_fits_list <- lapply(cells.tibble.list, function(tibb) {
      tibb %>%
        filter(measure==meas) %>%
        mutate(x=ifelse(value==0,1e-2,value)) %>%
        filter(drug_type == 'broad') %>%
        group_by(drug, drug_type) %>%
        do(mutate(fit_beta_mle(.$x),number = nrow(.))) %>%
        ungroup() %>% 
        mutate(alpha=opt$broad.alpha.prior,beta=opt$broad.beta.prior) %>%
        mutate(prior = .05)
    })
  }
```

Perform an expectation step using the distributions to initialize for the EM. 
```{r}
  drug_assignments_list <- lapply(1:length(drugs.tibble.list), function(num) {
    drugs.tibble.list[[num]] %>%
      filter(measure==meas) %>%
      select(-drug_type) %>%
      crossing(drug_types_list[[num]]) %>%
      mutate(likelihood = prior * VGAM::dbetabinom.ab(sensitive, cell_count, alpha, beta)) %>%
      group_by(drug) %>%
      mutate(posterior=likelihood/sum(likelihood)) %>%
      top_n(1, likelihood) %>%
      ungroup()
  })
  targetted_cell_assignments_list <- lapply(1:length(targetted_drug_fits_list), function(num) {
    targetted_drug_list <- unique(targetted_drug_fits_list[[num]]$drug)
    targetted_cell_assignments <- lapply(targetted_drug_list, function(dr) {
      cells.tibble.list[[num]] %>%
        filter(drug == dr,measure==meas) %>%
        select(drug:drug_type) %>%
        mutate(x=round(value*1e3),n=1e3) %>%
        crossing(targetted_drug_fits_list[[num]] %>% filter(drug == dr) %>% select(-drug,-drug_type)) %>%
        mutate(likelihood = prior * VGAM::dbetabinom.ab(x, n, alpha, beta)) %>%
        group_by(drug, cell) %>%
        mutate(posterior=likelihood/sum(likelihood)) %>%
        top_n(1, likelihood) %>%
        ungroup()
    })
    do.call(bind_rows, targetted_cell_assignments)
  })
  broad_cell_assignments_list <- lapply(1:length(broad_drug_fits_list), function(num) {
    cells.tibble.list[[num]] %>%
        filter(drug %in% unique(broad_drug_fits_list[[num]]$drug),measure==meas) %>%
        select(drug:drug_type) %>%
        mutate(x=ifelse(value==0,1e-3,value)) %>%
        left_join(broad_drug_fits_list[[num]], by=c('drug','drug_type')) %>%
        mutate(likelihood = 1 * dbeta(x, alpha, beta),
               x=x*1e3,n=1e3,
               cell_type = ifelse(value>=qbeta(.95,.$alpha,.$beta),'sensitive','resistant'))
  })
  cell_assignments_list <- lapply(1:length(targetted_cell_assignments_list), function(num) {
    bind_rows(targetted_cell_assignments_list[[num]],broad_cell_assignments_list[[num]])
  })
  names(cell_assignments_list) <- names(drug_types_list)
```

Plot the prior drug densities.
```{r}  
for (num in names(drug_types_list)) {
  drug_type_iterations <- drug_types_list[[num]]
  drug_fits_iterations <- bind_rows(broad_drug_fits_list[[num]],targetted_drug_fits_list[[num]])
  cell_assignments_iterations <- cell_assignments_list[[num]]
  betadens <- drug_fits_iterations %>%
    mutate(cross = paste(cell_type, drug, sep='_')) %>%
    plyr::ddply(., "cross", function(df) {
      data.frame( 
      value = seq(.001, .999, length = 1000),
      beta_curve = dbeta(seq(.001, .999, length = 1000), 
                           df$alpha, 
                           df$beta) 
    )
  })
  betadens <- as_tibble(betadens) %>% 
    separate(cross,into=c('cell_type','drug'),sep='_') %>%
    full_join(drug_fits_iterations %>% mutate(cell_type = ifelse(is.na(cell_type),'NA',cell_type)), by=c('drug','cell_type')) %>%
    group_by(drug,cell_type) %>% 
    mutate(prior = ifelse(prior < .1,.1,prior)) %>%
    mutate(beta_curve = beta_curve/max(beta_curve)*prior) %>%
    ungroup() %>%
    filter(beta_curve>1e-5) %>%
    mutate(cell_type = ifelse(cell_type=='sensitive','sensitive','resistant'))
  p <- cell_assignments_iterations %>%
    ggplot(aes(value,y=..scaled..)) +
      geom_density(adjust=.5,fill=1) +
      theme_bw() + 
      facet_wrap(vars(drug), scales = 'free_y',ncol=3) + 
      theme(strip.text.x = element_text(size = 8),
          legend.position='none',
          axis.text=element_text(size=12),
          axis.title=element_text(size=12),
          legend.text=element_text(size=12),
          legend.title=element_text(size=12),
          title=element_text(size=14)) + 
    scale_x_continuous(limits = c(0,1), name=meas) + 
    geom_line(data=betadens, aes(y = beta_curve, color=cell_type), lwd = 1) 
  ggsave(p,file=file.path(opt$log_dir,meas,num,paste('prior_densities_smoothed.pdf',sep='')),width = 12, height = 24, units = "in")
  saveRDS(p, file=file.path(opt$log_dir,meas,num,paste('prior_densities_smoothed.RDS',sep='')))
  while(dev.cur()!=1) {dev.off()}
  dir.create(file.path(opt$log_dir,meas,num,'prior_densities_by_drug'),showWarnings = FALSE)
  for (dr in unique(cell_assignments_iterations$drug)) {
    dr_type <- cell_assignments_iterations %>%
      filter(drug==dr) %>% 
      distinct(drug_type) %>% 
      pull
    p <- cell_assignments_iterations %>%
      filter(drug==dr) %>%
      ggplot(aes(value,y=..scaled..)) +
        geom_density(adjust=.5,fill=1) +
        theme_bw() + 
        theme(strip.text.x = element_text(size = 18),
          legend.position='none',
          axis.text=element_text(size=16),
          axis.title=element_text(size=18),
          legend.text=element_text(size=16),
          legend.title=element_text(size=16),
          title=element_text(size=18)) +
      scale_x_continuous(limits = c(0,1)) + 
      labs(y='Scaled Density',x='AOC') +
      geom_line(data=betadens %>% filter(drug==dr), aes(y = beta_curve, color=cell_type), lwd = 1.5) +
      ggtitle(paste(dr,sep=' '))
    ggsave(p, file=file.path(opt$log_dir,meas,num,'prior_densities_by_drug',paste(dr,'.png',sep='')),width = 12, height = 8, units = "in")
    saveRDS(p, file=file.path(opt$log_dir,meas,num,'prior_densities_by_drug',paste(dr,'.RDS',sep='')))
  }
}
```

Run EM.
```{r}
  iterations_list <- list()
  for(num in 1:length(cell_assignments_list)) {
    drug_assignments <- drug_assignments_list[[num]]
    cell_assignments <- cell_assignments_list[[num]]
    iterations_list[[num]] <- accumulate(1:3, iterate_em, .init = list(drug_assignments = drug_assignments,
                                                                       cell_assignments = cell_assignments))
  }
  names(iterations_list) <- names(sensitivity.tibble.list)
```

Plot parameters across iterations.
```{r}
for (num in names(iterations_list)) {
  drug_type_iterations <- iterations_list[[num]] %>% 
    map_df("drug_types", .id = "iteration") %>% 
    bind_rows(drug_types_list[[num]] %>% 
                mutate(iteration='0'))
  drug_fits_iterations <- iterations_list[[num]] %>% 
    map_df("drug_fits", .id = "iteration") %>% 
    bind_rows(broad_drug_fits_list[[num]] %>% 
                mutate(iteration='0'),
              targetted_drug_fits_list[[num]] %>% 
                mutate(iteration='0'))
  cell_assignments_iterations <- iterations_list[[num]] %>% 
    map_df("cell_assignments", .id = "iteration") %>% 
    bind_rows(cell_assignments_list[[num]] %>%
                mutate(iteration='0'))
  p <- drug_type_iterations %>%
    crossing(x = seq(.001, .999, .001)) %>%
    mutate(density = prior * dbeta(x, alpha, beta)) %>%
    ggplot(aes(x, density, color = iteration, group = iteration)) +
    geom_line() +
    facet_wrap(~ drug_type) + 
    theme(strip.text.x = element_text(size = 18),
          legend.position='bottom',
          axis.text=element_text(size=16),
          axis.title=element_text(size=18),
          legend.text=element_text(size=16),
          legend.title=element_text(size=16),
          title=element_text(size=18)) +
          labs(y='Density',x='AOC')
  ggsave(p,file=file.path(opt$log_dir,meas,num,paste('parameter_updates.pdf',sep='')),width = 12, height = 8, units = "in")
  saveRDS(p,file=file.path(opt$log_dir,meas,num,paste('parameter_updates.RDS',sep='')))
}
```

Plot the posterior drug densities.
```{r}  
for (num in names(iterations_list)) {
  drug_type_iterations <- iterations_list[[num]] %>% 
    map_df("drug_types", .id = "iteration") %>% 
    bind_rows(drug_types_list[[num]] %>% 
                mutate(iteration='0'))
  drug_fits_iterations <- iterations_list[[num]] %>% 
    map_df("drug_fits", .id = "iteration") %>% 
    bind_rows(broad_drug_fits_list[[num]] %>% 
                mutate(iteration='0'),
              targetted_drug_fits_list[[num]] %>% 
                mutate(iteration='0'))
  cell_assignments_iterations <- iterations_list[[num]] %>% 
    map_df("cell_assignments", .id = "iteration") %>% 
    bind_rows(cell_assignments_list[[num]] %>%
                mutate(iteration='0'))
  betadens <- drug_fits_iterations %>%
    filter(iteration==max(iteration)) %>%
    mutate(cross = paste(cell_type, drug, sep='_')) %>%
    plyr::ddply(., "cross", function(df) {
      data.frame( 
      value = seq(.001, .999, length = 1000),
      beta_curve = dbeta(seq(.001, .999, length = 1000), 
                           df$alpha, 
                           df$beta) 
    )
  })
  betadens <- as_tibble(betadens) %>% 
    separate(cross,into=c('cell_type','drug'),sep='_') %>%
    full_join(drug_fits_iterations %>% mutate(cell_type = ifelse(is.na(cell_type),'NA',cell_type)), by=c('drug','cell_type')) %>%
    group_by(drug,cell_type) %>% 
    #mutate(prior = ifelse(prior < .1,.1,prior)) %>%
    mutate(beta_curve = beta_curve/max(beta_curve)*prior) %>%
    ungroup() %>%
    filter(iteration==max(iteration)) %>%
    mutate(cell_type = ifelse(cell_type=='sensitive','sensitive','resistant'))
  p <- cell_assignments_iterations %>%
    filter(iteration==max(iteration)) %>%
    ggplot(aes(value,y=..scaled..)) +
      geom_density(adjust=.5,fill=1) +
      theme_bw() + 
      facet_wrap(vars(drug), scales = 'free_y',ncol=3) + 
      theme(strip.text.x = element_text(size = 8),
          legend.position='none',
          axis.text=element_text(size=12),
          axis.title=element_text(size=12),
          legend.text=element_text(size=12),
          legend.title=element_text(size=12),
          title=element_text(size=14)) + 
    scale_x_continuous(limits = c(0,1), name=meas) + 
    geom_line(data=betadens, aes(y = beta_curve, color=cell_type), lwd = 1) 
  ggsave(p, file=file.path(opt$log_dir,meas,num,paste('fitted_densities_smoothed.pdf',sep='')),width = 12, height = 24, units = "in")
  saveRDS(p, file=file.path(opt$log_dir,meas,num,paste('fitted_densities_smoothed.RDS',sep='')))
  while(dev.cur()!=1) {dev.off()}
  dir.create(file.path(opt$log_dir,meas,num,'fitted_densities_by_drug'),showWarnings = FALSE)
  for (dr in unique(cell_assignments_iterations$drug)) {
    dr_type <- cell_assignments_iterations %>%
      filter(iteration==max(iteration),drug==dr) %>% 
      distinct(drug_type) %>% 
      pull
    p <- cell_assignments_iterations %>%
      filter(iteration==max(iteration),drug==dr) %>%
      ggplot(aes(value,y=..scaled..)) +
        geom_density(adjust=.5,fill=1) +
        theme_bw() + 
        theme(strip.text.x = element_text(size = 18),
          legend.position='none',
          axis.text=element_text(size=16),
          axis.title=element_text(size=18),
          legend.text=element_text(size=16),
          legend.title=element_text(size=16),
          title=element_text(size=18)) +
      scale_x_continuous(limits = c(0,1)) + 
      labs(y='Scaled Density',x='AOC') +
      geom_line(data=betadens %>% filter(drug==dr), aes(y = beta_curve, color=cell_type), lwd = 1.5) +
      ggtitle(paste(dr,sep=' '))
    ggsave(file=file.path(opt$log_dir,meas,num,'fitted_densities_by_drug',paste(dr,'.png',sep='')),width = 12, height = 8, units = "in")
    saveRDS(p, file.path(opt$log_dir,meas,num,'fitted_densities_by_drug',paste(dr,'.RDS',sep='')))
  }
}
```

Obtain posterior information from last EM rep.
```{r}
  posterior_drug_types_list <- lapply(names(iterations_list), function(num) {
    iterations_list[[num]] %>% 
      map_df("drug_types", .id = "iteration") %>% 
      filter(iteration==max(iteration)) %>% 
      rename(posterior=prior)
  })
  posterior_drug_assignments_list <- lapply(names(iterations_list), function(num) {
    iterations_list[[num]] %>% 
      map_df("drug_assignments", .id = "iteration") %>% 
      filter(iteration==max(iteration))
  })
  posterior_drug_fits_list <- lapply(names(iterations_list), function(num) {
    iterations_list[[num]] %>% 
      map_df("drug_fits", .id = "iteration") %>% 
      filter(iteration==max(iteration))
  })
  posterior_cell_assignments_list <- lapply(names(iterations_list), function(num) {
    iterations_list[[num]] %>% 
      map_df("cell_assignments", .id = "iteration") %>% 
      filter(iteration==max(iteration))
  })
  names(posterior_cell_assignments_list) <- names(iterations_list)
```

Extract intersection data.
```{r}
  intersection.fitted.list <- lapply(intersection.tibble.list, function(tibb) {
    drugs_cells <- tibb %>% 
      distinct(drug,cell)
    experiments <- tibb %>% 
      distinct(experiment) %>%
      pull
    newtibb <- NULL
    for (exp in experiments) {
      iter <- iterations_list[[exp]] %>% 
        map_df("cell_assignments", .id = "iteration") %>%
        filter(iteration == max(iteration))
      newtibb <- bind_rows(newtibb,drugs_cells %>% 
        left_join(iter, by=c('drug','cell')))
    }
    return(newtibb)
  })
```

Format posterior agreements.
```{r}
  posterior_drug_types <- do.call(bind_rows,posterior_drug_types_list) %>%
    mutate(experiment=rep(names(iterations_list),each=2)) 
  nums <- sapply(posterior_drug_assignments_list, nrow)
  posterior_drug_assignments <- do.call(bind_rows,posterior_drug_assignments_list) %>%
      mutate(experiment=rep(names(iterations_list),times=nums))
  nums <- sapply(posterior_drug_fits_list, nrow)
  posterior_drug_fits <-  do.call(bind_rows,posterior_drug_fits_list) %>%
      mutate(experiment=rep(names(iterations_list),times=nums))
  nums <- sapply(posterior_cell_assignments_list, nrow)
  posterior_cell_assignments <- do.call(bind_rows,posterior_cell_assignments_list) %>%
      mutate(experiment=rep(names(iterations_list),times=nums))
```

Save posteriors.
```{r}
saveRDS(object=posterior_drug_types,file=file.path(opt$log_dir,'posterior_drug_types.RDS'))
saveRDS(object=posterior_drug_assignments,file=file.path(opt$log_dir,'posterior_drug_assignments.RDS'))
saveRDS(object=posterior_drug_fits,file=file.path(opt$log_dir,'posterior_drug_assignments.RDS'))
saveRDS(object=posterior_cell_assignments,file=file.path(opt$log_dir,'posterior_cell_assignments.RDS'))
saveRDS(object=intersection.fitted.list,file=file.path(opt$log_dir,'intersection.fitted.list.RDS'))
```

Posterior drug type density plot.
```{r}
p <- posterior_drug_types %>% 
  crossing(x = seq(.001, .999, .001)) %>%
    mutate(density = posterior * dbeta(x, alpha, beta)) %>%
    ggplot(aes(x, density, color = drug_type, group = drug_type)) +
    geom_line() +
    facet_wrap(~ experiment,ncol=1) + 
    theme_bw() + 
        theme(strip.text.x = element_text(size = 18),
          legend.position='bottom',
          axis.text=element_text(size=16),
          axis.title=element_text(size=18),
          legend.text=element_text(size=18),
          legend.title=element_text(size=18),
          title=element_text(size=18)) +
    labs(colour="Drug Type",y='Density',x='AOC') + 
    scale_x_continuous(limits = c(0,1), breaks=c(0,.5,1)) + 
    ggtitle('Posterior Drug-Type Densities')
  ggsave(p, file=file.path(opt$log_dir,meas,paste('posterior_drug_types.pdf',sep='')),width = 12, height = 8, units = "in")
  saveRDS(p, file.path(opt$log_dir,meas,paste('posterior_drug_types.RDS',sep='')))
```

Compute pairwise posterior drug assignments agreement.
```{r}
pairwise_drug_agreements <- tibble()
for (comp in names(intersection.fitted.list)) {
  combos <- t(combn(sort(unique(intersection.fitted.list[[comp]]$experiment)),2))
  for (combo in 1:nrow(combos)) {
    pairwise_drug_agreements <- posterior_drug_assignments %>% 
      filter(experiment %in% combos[combo,]) %>%
      select(drug:measure,posterior, drug_type,experiment) %>% 
      unite(temp,drug,measure,experiment,sep='__') %>%
      gather(key=var,value=val,-temp) %>% 
      separate(temp,into=c('drug','measure','experiment'),sep='__') %>%
      unite(var,experiment,var) %>%
      spread(var,val) %>% 
      na.omit %>%
      mutate_at(vars(paste(combos[combo,1],'posterior',sep='_'),paste(combos[combo,2],'posterior',sep='_')),as.numeric) %>%
      mutate_(g1 = paste(combos[combo,1],'drug_type',sep='_'), g2 = paste(combos[combo,2],'drug_type',sep='_')) %>%
      mutate(Called=case_when(g1==g2 & g1 == 'broad'~'Broadly-active',
                                 g1==g2 & g1 == 'targeted'~'Targeted',
                                 TRUE ~ 'Disagree')) %>%
      mutate(agreement = case_when(Called!='Disagree' ~ eval(parse(text=paste(combos[combo,1],'posterior',sep='_')))*
               eval(parse(text=paste(combos[combo,2],'posterior',sep='_'))) + 
                (1-eval(parse(text=paste(combos[combo,1],'posterior',sep='_'))))*
                (1-eval(parse(text=paste(combos[combo,2],'posterior',sep='_')))),
               TRUE ~ (1-eval(parse(text=paste(combos[combo,1],'posterior',sep='_'))))*
               eval(parse(text=paste(combos[combo,2],'posterior',sep='_'))) + 
                eval(parse(text=paste(combos[combo,1],'posterior',sep='_')))*
                (1-eval(parse(text=paste(combos[combo,2],'posterior',sep='_')))))) %>%
      select(drug, measure,agreement, Called) %>% 
      mutate(Intersection = comp, Comparison=paste(combos[combo,1],combos[combo,2],sep='_')) %>%
      bind_rows(pairwise_drug_agreements)
  }
}
```

Pairwise posterior drug assignments plots.
```{r}
library(ggrepel)
for (comp in names(intersection.fitted.list)) {
  combos <- t(combn(sort(unique(intersection.fitted.list[[comp]]$experiment)),2))
  for (combo in 1:nrow(combos)) {
  p <- posterior_drug_assignments %>% 
    filter(experiment %in% combos[combo,]) %>%
    mutate(posterior = case_when(drug_type=='broad' ~ 1-posterior,
                                 drug_type=='targeted' ~ posterior)) %>%
    select(drug:measure,posterior, drug_type,experiment) %>% 
    unite(temp,drug,measure,experiment,sep='__') %>%
    gather(key=var,value=val,-temp) %>% 
    separate(temp,into=c('drug','measure','experiment'),sep='__') %>%
    unite(var,experiment,var) %>%
    spread(var,val) %>% 
    na.omit %>%
    mutate_at(vars(paste(combos[combo,1],'posterior',sep='_'),paste(combos[combo,2],'posterior',sep='_')),as.numeric) %>%
    mutate_(g1 = paste(combos[combo,1],'drug_type',sep='_'), g2 = paste(combos[combo,2],'drug_type',sep='_')) %>%
    mutate(Agreement=case_when(g1==g2 & g1 == 'broad'~'Broadly-active',
                               g1==g2 & g1 == 'targeted'~'Targeted',
                               TRUE~ 'Disagree')) %>%
    ggplot(aes_string(x=paste(combos[combo,1],'posterior',sep='_'),
                y=paste(combos[combo,2],'posterior',sep='_'), 
                color = 'Agreement', 
                label='drug')) +
      geom_point() +
      geom_text_repel(show.legend=FALSE,size=5) + 
      theme_bw() + 
      theme(strip.text.x = element_text(size = 18),
            legend.position='bottom',
            axis.text=element_text(size=16),
            axis.title=element_text(size=18),
            legend.text=element_text(size=18),
            legend.title=element_text(size=0),
            title=element_text(size=18)) +
      labs(y=combos[combo,2],x=combos[combo,1]) + 
      scale_x_continuous(limits = c(0,1), breaks=c(0,.5,1)) + 
      scale_y_continuous(limits = c(0,1), breaks=c(0,.5,1)) + 
      ggtitle('Posterior Probability of Targeted')
  ggsave(p,file=file.path(opt$log_dir,meas,comp,paste('posterior_drug_types_individual.pdf',sep='')),width = 12, height = 8, units = "in")
  saveRDS(p, file.path(opt$log_dir,meas,comp,paste('posterior_drug_types_individual.RDS',sep='')))
  }
}
```

Compute pairwise posterior cell agreement.
```{r}
pairwise_cell_agreements <- tibble()
for (comp in names(intersection.fitted.list)) {
  combos <- t(combn(sort(unique(intersection.fitted.list[[comp]]$experiment)),2))
  for (combo in 1:nrow(combos)) {
    pairwise_cell_agreements <- intersection.fitted.list[[comp]] %>%
      filter(experiment %in% combos[combo,]) %>% 
      select(drug,cell,experiment, measure, cell_type, value, drug_type, posterior) %>%
      gather(variable, value, -(drug:measure)) %>% 
      unite(temp, experiment, variable) %>%
      spread(temp,value) %>%
      mutate_at(vars(ends_with('_value')),funs(as.numeric)) %>%
      mutate_at(vars(ends_with('_posterior')),funs(as.numeric)) %>%
      group_by(drug, cell, measure) %>%
      mutate_(g1 = paste(combos[combo,1],'drug_type',sep='_'), g2 = paste(combos[combo,2],'drug_type',sep='_')) %>%
      mutate(Called=case_when(g1==g2 & g1 == 'broad'~'Broadly-active',
                                 g1==g2 & g1 == 'targeted'~'Targeted',
                                 TRUE ~ 'Disagree')) %>%
      mutate(agreement = case_when(Called!='Disagree' ~ eval(parse(text=paste(combos[combo,1],'posterior',sep='_')))*
               eval(parse(text=paste(combos[combo,2],'posterior',sep='_'))) + 
                (1-eval(parse(text=paste(combos[combo,1],'posterior',sep='_'))))*
                (1-eval(parse(text=paste(combos[combo,2],'posterior',sep='_')))),
               TRUE ~ (1-eval(parse(text=paste(combos[combo,1],'posterior',sep='_'))))*
               eval(parse(text=paste(combos[combo,2],'posterior',sep='_'))) + 
                eval(parse(text=paste(combos[combo,1],'posterior',sep='_')))*
                (1-eval(parse(text=paste(combos[combo,2],'posterior',sep='_')))))) %>%
      mutate(Intersection = comp, Comparison=paste(combos[combo,1],combos[combo,2],sep='_')) %>%
      select(cell,drug,measure,agreement,Called, Intersection, Comparison) %>%
      bind_rows(pairwise_cell_agreements) 
  }
}
```

2-way concordance plots between studies for only those drugs/cells in the intersection, colored by posterior agreement.
```{r}
for (comp in names(intersection.fitted.list)) {
  dir.create(file.path(opt$log_dir,meas,comp,'by_drug'),showWarnings = FALSE)
  combos <- t(combn(sort(unique(intersection.fitted.list[[comp]]$experiment)),2))
  for (combo in 1:nrow(combos)) {
    p <- intersection.fitted.list[[comp]] %>%
      filter(experiment %in% combos[combo,]) %>% 
      select(drug,cell,experiment, measure, cell_type, value, drug_type, posterior) %>%
      gather(variable, value, -(drug:measure)) %>% 
      unite(temp, experiment, variable) %>%
      spread(temp,value) %>%
      mutate_at(vars(ends_with('_value')),funs(as.numeric)) %>%
      mutate_at(vars(ends_with('_posterior')),funs(as.numeric)) %>%
      group_by(drug, cell, measure) %>%
      mutate_(g1 = paste(combos[combo,1],'drug_type',sep='_'), g2 = paste(combos[combo,2],'drug_type',sep='_')) %>%
      mutate(Called=case_when(g1==g2 & g1 == 'broad'~'Broadly-active',
                                 g1==g2 & g1 == 'targeted'~'Targeted',
                                 TRUE ~ 'Disagree')) %>%
      mutate(agreement = case_when(Called!='Disagree' ~ eval(parse(text=paste(combos[combo,1],'posterior',sep='_')))*
               eval(parse(text=paste(combos[combo,2],'posterior',sep='_'))) + 
                (1-eval(parse(text=paste(combos[combo,1],'posterior',sep='_'))))*
                (1-eval(parse(text=paste(combos[combo,2],'posterior',sep='_')))),
               TRUE ~ (1-eval(parse(text=paste(combos[combo,1],'posterior',sep='_'))))*
               eval(parse(text=paste(combos[combo,2],'posterior',sep='_'))) + 
                eval(parse(text=paste(combos[combo,1],'posterior',sep='_')))*
                (1-eval(parse(text=paste(combos[combo,2],'posterior',sep='_')))))) %>%
      ggplot(aes_string(x=paste(combos[combo,1],'value',sep='_'),
                        y=paste(combos[combo,2],'value',sep='_'))) + 
      geom_point(aes(color=agreement),alpha=1,size=2) + 
      scale_colour_gradient2(midpoint=.5,limits = c(0,1),mid='grey50') + 
      theme_bw() + 
      facet_wrap(vars(drug),ncol=3) + 
      theme(strip.text.x = element_text(size = 18),
          legend.position='top',
          axis.text=element_text(size=16),
          axis.title=element_text(size=18),
          legend.text=element_text(size=16),
          legend.title=element_text(size=0),
          title=element_text(size=14)) +
      scale_x_continuous(breaks=c(0,.5,1),labels=c('0','0.5','1'),limits = c(0,1)) +
      scale_y_continuous(breaks=c(0,.5,1),labels=c('0','0.5','1'),limits = c(0,1))
    ggsave(p, file=file.path(opt$log_dir,meas,comp,paste('2way_posterior_',
                                          combos[combo,1],'_',combos[combo,2],
                                          '.pdf',sep='')),
         width = 10, height = 18, units = "in")
    saveRDS(p,file.path(opt$log_dir,meas,comp,paste('2way_posterior_',
                                          combos[combo,1],'_',combos[combo,2],
                                          '.RDS',sep='')))
    drugs <- unique(intersection.fitted.list[[comp]]$drug)
    for (dr in drugs) {
      p <- intersection.fitted.list[[comp]] %>%
      filter(experiment %in% combos[combo,],drug==dr) %>% 
      select(drug,cell,experiment, measure, cell_type, value, drug_type, posterior) %>%
      gather(variable, value, -(drug:measure)) %>% 
      unite(temp, experiment, variable) %>%
      spread(temp,value) %>%
      mutate_at(vars(ends_with('_value')),funs(as.numeric)) %>%
      mutate_at(vars(ends_with('_posterior')),funs(as.numeric)) %>%
      group_by(drug, cell, measure) %>%
      mutate(agreement = eval(parse(text=paste(combos[combo,1],'posterior',sep='_')))*
               eval(parse(text=paste(combos[combo,2],'posterior',sep='_'))) + 
                (1-eval(parse(text=paste(combos[combo,1],'posterior',sep='_'))))*
                (1-eval(parse(text=paste(combos[combo,2],'posterior',sep='_'))))) %>%
      ggplot(aes_string(x=paste(combos[combo,1],'value',sep='_'),
                        y=paste(combos[combo,2],'value',sep='_'))) + 
      geom_point(aes(color=agreement),alpha=1,size=2) + 
      scale_colour_gradient2(midpoint=.5,limits = c(0,1),mid='grey50',breaks=c(0,0.5,1),labels=c(0,0.5,1)) + 
      theme_bw() + 
      ggtitle(paste(dr,'Posterior Agreement')) +
      theme(strip.text.x = element_text(size = 12),
          legend.position='top',
          axis.text=element_text(size=12),
          axis.title=element_text(size=12),
          legend.text=element_text(size=12),
          legend.title=element_text(size=0),
          title=element_text(size=14)) +
      labs(x=combos[combo,1],y=combos[combo,2]) + 
      scale_x_continuous(breaks=c(0,.5,1),labels=c('0','0.5','1'),limits = c(0,1)) +
      scale_y_continuous(breaks=c(0,.5,1),labels=c('0','0.5','1'),limits = c(0,1))
    ggsave(p,file=file.path(opt$log_dir,meas,comp,'by_drug',paste(dr,'_posterior_',
                                            combos[combo,1],'_',combos[combo,2],
                                            '.pdf',sep='')),
           width = 12, height = 8, units = "in")
    saveRDS(p,file.path(opt$log_dir,meas,comp,'by_drug',paste(dr,'_posterior_',
                                            combos[combo,1],'_',combos[combo,2],
                                            '.RDS',sep='')))
    }
  }
}
```

QQ plots.
```{r}
for (num in names(iterations_list)) {
  cell_assignments_iterations1 <- posterior_cell_assignments %>%
    filter(experiment==num) %>%
    mutate(cum_beta = pbeta(value, shape1 = .$alpha,shape2=.$beta)) 
  betadens <- posterior_drug_fits %>%
    filter(experiment==num) %>%
    mutate(cross = paste(cell_type, drug, sep='_')) %>%
    plyr::ddply(., "cross", function(df) {
      data.frame( 
      value = seq(.01, .99, length = 100),
      cum_beta_curve = qbeta(seq(.01, .99, length = 100), 
                           df$alpha, 
                           df$beta) 
    )
  })
  betadens <- as_tibble(betadens) %>% 
    separate(cross,into=c('cell_type','drug'),sep='_') %>%
    full_join(posterior_drug_fits %>% filter(experiment==num) %>% mutate(cell_type = ifelse(is.na(cell_type),'NA',cell_type)), by=c('drug','cell_type')) %>%
    mutate(cell_type = ifelse(cell_type=='sensitive','sensitive','resistant'))
  p <- cell_assignments_iterations1 %>%
    filter(experiment==num) %>%
    mutate(cell_type2 = ifelse(drug_type == 'broad','resistant',cell_type)) %>%
    group_by(drug,cell_type2) %>%
    arrange(value) %>%
    mutate(rank=row_number()/(n()+1)) %>%
    ungroup() %>%
    mutate(cum_beta = qbeta(.$rank,shape1 = .$alpha,shape2=.$beta)) %>%
    ggplot(aes(x=cum_beta,y=value,color=cell_type)) +
      geom_point() +  
      theme_bw() + 
      facet_wrap(vars(drug), ncol=3) + 
      theme(strip.text.x = element_text(size = 8),
          legend.position='none',
          axis.text=element_text(size=12),
          axis.title=element_text(size=12),
          legend.text=element_text(size=12),
          legend.title=element_text(size=12),
          title=element_text(size=14)) + 
    scale_x_continuous(limits = c(0,1), name=meas) + 
    geom_abline(aes(slope=1, intercept = 0), lwd = 1) 
  ggsave(p, file=file.path(opt$log_dir,meas,num,paste('fitted_densities_qq.pdf',sep='')),width = 12, height = 24, units = "in")
  saveRDS(p, file=file.path(opt$log_dir,meas,num,paste('fitted_densities_qq.RDS',sep='')))
  while(dev.cur()!=1) {dev.off()}
  dir.create(file.path(opt$log_dir,meas,num,'fitted_densities_by_drug'),showWarnings = FALSE)
  for (dr in unique(cell_assignments_iterations1$drug)) {
    dr_type <- cell_assignments_iterations1 %>%
      filter(drug==dr) %>% 
      distinct(drug_type) %>% 
      pull
    betamix <- function(x, param1, param2, pmix) {
      if (dr_type == 'targeted' & length(param1)>1 & length(param2)>1 & length(pmix)>1) {
        pmix[1]*pbeta(x,param1[1],param2[1]) + pmix[2]*pbeta(x,param1[2],param2[2])
      } else {
        pbeta(x,param1,param2)
      }
    }
    tvals <- cell_assignments_iterations1 %>%
      filter(drug==dr)
    param1 <- unique(tvals$alpha)
    param2 <- unique(tvals$beta)
    probs <- unique(tvals$prior)
    kss <- suppressWarnings(ks.test(tvals$value,'betamix',param1,param2,probs))
    p <- cell_assignments_iterations1 %>%
      filter(drug==dr) %>%
      mutate(cell_type2 = ifelse(drug_type == 'broad','resistant',cell_type)) %>%
      group_by(drug,cell_type2) %>%
      arrange(value) %>%
      mutate(rank=row_number()/(n()+1)) %>%
      ungroup() %>%
      mutate(cum_beta = qbeta(.$rank,shape1 = .$alpha,shape2=.$beta)) %>%
      ggplot(aes(x=cum_beta,y=value,color=cell_type)) +
        geom_point() +
        theme_bw() + 
        theme(strip.text.x = element_text(size = 18),
          legend.position='none',
          axis.text=element_text(size=16),
          axis.title=element_text(size=18),
          legend.text=element_text(size=16),
          legend.title=element_text(size=16),
          title=element_text(size=18)) +
      scale_x_continuous(limits = c(0,1)) + scale_y_continuous(limits = c(0,1)) + 
      labs(y='Sample',x='Theoretical') +
      geom_abline(aes(slope=1,intercept=0)) + 
      annotate('text', x = .1, y = 1, label = paste('p=',round(kss$p.value,digits = 3),sep=''),size=6) +
      #geom_line(data=betadens %>% filter(experiment==num,drug==dr), aes(x=cum_beta_curve,y = value, color=cell_type), lwd = 1.5) +
      ggtitle(paste(dr,sep=' '))
    ggsave(file=file.path(opt$log_dir,meas,num,'fitted_densities_by_drug',paste(dr,'_qq.png',sep='')),width = 12, height = 8, units = "in")
    saveRDS(p, file.path(opt$log_dir,meas,num,'fitted_densities_by_drug',paste(dr,'_qq.RDS',sep='')))
  }
}
```

Compute study agreements.
```{r}
pairwise_study_agreements <- tibble()
for (comp in names(intersection.fitted.list)) {
  combos <- t(combn(sort(unique(intersection.fitted.list[[comp]]$experiment)),2))
  for (combo in 1:nrow(combos)) {
   tdat <- intersection.fitted.list[[comp]] %>%
      filter(experiment %in% combos[combo,]) %>% 
      select(drug,cell,experiment, measure, cell_type, value, drug_type, posterior) %>%
      gather(variable, value, -(drug:measure)) %>% 
      unite(temp, experiment, variable) %>%
      spread(temp,value) %>%
      mutate_at(vars(ends_with('_value')),funs(as.numeric)) %>%
      mutate_at(vars(ends_with('_posterior')),funs(as.numeric)) 
   corrdat <- tdat %>%
      na.omit() %>%
      group_by(drug, measure) %>%
      summarise(pearson_corr = cor(eval(parse(text=paste(combos[combo,1],'value',sep='_'))),
                                eval(parse(text=paste(combos[combo,2],'value',sep='_'))),
                                method='pearson'),
             spearman_corr = cor(eval(parse(text=paste(combos[combo,1],'value',sep='_'))),
                                eval(parse(text=paste(combos[combo,2],'value',sep='_'))),
                                method='spearman')) %>%
      ungroup()
     lordat <- tdat %>% 
       group_by(drug, measure) %>% 
       na.omit() %>%
       mutate(Drug_type = case_when((eval(parse(text=paste(combos[combo,1],'drug_type',sep='_')))=='broad') & 
                                 (eval(parse(text=paste(combos[combo,2],'drug_type',sep='_')))=='broad') ~ 'Broad',
                                 (eval(parse(text=paste(combos[combo,1],'drug_type',sep='_')))=='targeted') & 
                                 (eval(parse(text=paste(combos[combo,2],'drug_type',sep='_')))=='targeted') ~ 'Targeted',
                                 TRUE ~ 'Disagree')) %>%
       summarise(Drug_type = first(Drug_type),
                 t00 = sum((eval(parse(text=paste(combos[combo,1],'cell_type',sep='_')))=='resistant') &
                           (eval(parse(text=paste(combos[combo,2],'cell_type',sep='_')))=='resistant')),
                 t11 = sum((eval(parse(text=paste(combos[combo,1],'cell_type',sep='_')))=='sensitive') &
                           (eval(parse(text=paste(combos[combo,2],'cell_type',sep='_')))=='sensitive')),
                 t01 = sum((eval(parse(text=paste(combos[combo,1],'cell_type',sep='_')))=='resistant') &
                           (eval(parse(text=paste(combos[combo,2],'cell_type',sep='_')))=='sensitive')),
                 t10 = sum((eval(parse(text=paste(combos[combo,1],'cell_type',sep='_')))=='sensitive') &
                           (eval(parse(text=paste(combos[combo,2],'cell_type',sep='_')))=='resistant'))) %>%
       mutate(t00 = ifelse(t00==0,.5,t00),
              t11 = ifelse(t11==0,.5,t11),
              t10 = ifelse(t10==0,.5,t10),
              t01 = ifelse(t01==0,.5,t01)) %>% 
       ungroup() %>%
       mutate(LOR = log((t00*t11)/(t01*t10)),
              SE_LOR = sqrt(((1/t00)+(1/t11)+(1/t01) + (1/t10))))
     measuredat <- corrdat %>% left_join(lordat, by=c('drug','measure'))
     pairwise_study_agreements <- measuredat %>% 
       #mutate(agreement = ifelse(Drug_type =='Targeted',LOR,spearman_corr)) %>% 
       #select(drug,measure,agreement, Drug_type) %>%
       mutate(Intersection = comp, Comparison=paste(combos[combo,1],combos[combo,2],sep='_')) %>% 
       bind_rows(pairwise_study_agreements)
  }
}
```

Save cell, drug, and study agreements.
```{r}
saveRDS(object=pairwise_cell_agreements,file=file.path(opt$log_dir,'pairwise_cell_agreements.RDS'))
saveRDS(object=pairwise_drug_agreements,file=file.path(opt$log_dir,'pairwise_drug_agreements.RDS'))
saveRDS(object=pairwise_study_agreements,file=file.path(opt$log_dir,'pairwise_study_agreements.RDS'))
```

Plot pairwise correlations between sensitivity measures across drugs.
```{r}
library(ggrepel)
for (comp in names(intersection.fitted.list)) {
  combos <- t(combn(sort(unique(intersection.fitted.list[[comp]]$experiment)),2))
  for (combo in 1:nrow(combos)) {
   tdat <- intersection.fitted.list[[comp]] %>%
      filter(experiment %in% combos[combo,]) %>% 
      select(drug,cell,experiment, measure, cell_type, value, drug_type, posterior) %>%
      gather(variable, value, -(drug:measure)) %>% 
      unite(temp, experiment, variable) %>%
      spread(temp,value) %>%
      mutate_at(vars(ends_with('_value')),funs(as.numeric)) %>%
      mutate_at(vars(ends_with('_posterior')),funs(as.numeric)) 
   corrdat <- tdat %>%
      group_by(drug, measure) %>%
      summarise(pearson_corr = cor(eval(parse(text=paste(combos[combo,1],'value',sep='_'))),
                                eval(parse(text=paste(combos[combo,2],'value',sep='_'))),
                                method='pearson'),
             spearman_corr = cor(eval(parse(text=paste(combos[combo,1],'value',sep='_'))),
                                eval(parse(text=paste(combos[combo,2],'value',sep='_'))),
                                method='spearman')) %>%
      ungroup()
     lordat <- tdat %>% 
       group_by(drug, measure) %>% 
       mutate(Drug_type = case_when((eval(parse(text=paste(combos[combo,1],'drug_type',sep='_')))=='broad') & 
                                 (eval(parse(text=paste(combos[combo,2],'drug_type',sep='_')))=='broad') ~ 'Broad',
                                 (eval(parse(text=paste(combos[combo,1],'drug_type',sep='_')))=='targeted') & 
                                 (eval(parse(text=paste(combos[combo,2],'drug_type',sep='_')))=='targeted') ~ 'Targeted',
                                 TRUE ~ 'Disagree')) %>%
       summarise(Drug_type = first(Drug_type),
                 t00 = sum((eval(parse(text=paste(combos[combo,1],'cell_type',sep='_')))=='resistant') &
                           (eval(parse(text=paste(combos[combo,2],'cell_type',sep='_')))=='resistant')),
                 t11 = sum((eval(parse(text=paste(combos[combo,1],'cell_type',sep='_')))=='sensitive') &
                           (eval(parse(text=paste(combos[combo,2],'cell_type',sep='_')))=='sensitive')),
                 t01 = sum((eval(parse(text=paste(combos[combo,1],'cell_type',sep='_')))=='resistant') &
                           (eval(parse(text=paste(combos[combo,2],'cell_type',sep='_')))=='sensitive')),
                 t10 = sum((eval(parse(text=paste(combos[combo,1],'cell_type',sep='_')))=='sensitive') &
                           (eval(parse(text=paste(combos[combo,2],'cell_type',sep='_')))=='resistant'))) %>%
       mutate(t00 = ifelse(t00==0,.5,t00),
              t11 = ifelse(t11==0,.5,t11),
              t10 = ifelse(t10==0,.5,t10),
              t01 = ifelse(t01==0,.5,t01)) %>% 
       ungroup() %>%
       mutate(LOR = log((t00*t11)/(t01*t10)),
              SE_LOR = sqrt(((1/t00)+(1/t11)+(1/t01) + (1/t10))))
     measuredat <- corrdat %>% left_join(lordat, by=c('drug','measure'))
    p <- ggplot(measuredat, aes(x=spearman_corr,y=pearson_corr,label=drug)) + 
      geom_point(aes(color=Drug_type),alpha=1,size=2) + 
      geom_text_repel(show.legend=FALSE,size=5) + 
      theme_bw() + 
      theme(strip.text.x = element_text(size = 18),
          legend.position='top',
          axis.text=element_text(size=16),
          axis.title=element_text(size=18),
          legend.text=element_text(size=16),
          legend.title=element_text(size=0),
          title=element_text(size=14)) +
      labs(x='Spearman',y='Pearson') 
    ggsave(p, file=file.path(opt$log_dir,meas,comp,paste('Spearman_Pearson_',
                                          combos[combo,1],'_',combos[combo,2],
                                          '.pdf',sep='')),
         width = 8, height = 8, units = "in")
    saveRDS(p,file.path(opt$log_dir,meas,comp,paste('Spearman_Pearson_',
                                          combos[combo,1],'_',combos[combo,2],
                                          '.RDS',sep='')))
    p <- ggplot(measuredat, aes(x=spearman_corr,y=LOR,label=drug)) + 
      geom_point(aes(color=Drug_type),alpha=1,size=2) +
      geom_text_repel(show.legend=FALSE,size=5) + 
      theme_bw() + 
      theme(strip.text.x = element_text(size = 18),
          legend.position='top',
          axis.text=element_text(size=16),
          axis.title=element_text(size=18),
          legend.text=element_text(size=16),
          legend.title=element_text(size=0),
          title=element_text(size=14)) +
      labs(x='Spearman',y='Log-odds ratio') 
    ggsave(p, file=file.path(opt$log_dir,meas,comp,paste('Spearman_LOR_',
                                          combos[combo,1],'_',combos[combo,2],
                                          '.pdf',sep='')),
         width = 8, height = 8, units = "in")
    saveRDS(p,file.path(opt$log_dir,meas,comp,paste('Spearman_LOR_',
                                          combos[combo,1],'_',combos[combo,2],
                                          '.RDS',sep='')))
    p <- ggplot(measuredat, aes(x=pearson_corr,y=LOR,label=drug)) + 
      geom_point(aes(color=Drug_type),alpha=1,size=2) + 
      geom_text_repel(show.legend=FALSE,size=5) + 
      theme_bw() + 
      theme(strip.text.x = element_text(size = 18),
          legend.position='top',
          axis.text=element_text(size=16),
          axis.title=element_text(size=18),
          legend.text=element_text(size=16),
          legend.title=element_text(size=0),
          title=element_text(size=14)) +
      labs(x='Pearson',y='Log-odds ratio') + 
    ggsave(p, file=file.path(opt$log_dir,meas,comp,paste('Pearson_LOR_',
                                          combos[combo,1],'_',combos[combo,2],
                                          '.pdf',sep='')),
         width = 8, height = 8, units = "in")
    saveRDS(p,file.path(opt$log_dir,meas,comp,paste('Pearson_LOR_',
                                          combos[combo,1],'_',combos[combo,2],
                                          '.RDS',sep='')))
  }
}
```

Plot agreements for all pairwise study comparisons.
```{r}
p <- pairwise_study_agreements %>% 
  mutate(Drug_type = ifelse(Drug_type == 'Targeted','Log-odds','Spearman')) %>%
  #filter(Drug_type == 'Spearman') %>%
  filter(Drug_type == 'Log-odds') %>%
  group_by(Comparison) %>%
  arrange(desc(LOR)) %>%
  mutate(label = ifelse(row_number() %in% c(1:3,n()),drug,'')) %>%
  ungroup() %>%
  ggplot(aes(x=spearman_corr,y=LOR,color=Comparison,label=label)) +
  geom_point(alpha=.5,size=1.5) +
  geom_text_repel(show.legend=FALSE,size=4) +
  theme_bw() 
ggsave(p, file=file.path(opt$log_dir,meas,paste('pairwise_study_agreements_targeted.pdf',sep='')),width = 8, height = 8, units = "in")
saveRDS(p, file=file.path(opt$log_dir,meas,paste('pairwise_study_agreements_targeted.RDS',sep='')))
p <- pairwise_study_agreements %>% 
  mutate(Drug_type = ifelse(Drug_type == 'Targeted','Log-odds','Spearman')) %>%
  filter(Drug_type == 'Spearman') %>%
  #filter(Drug_type == 'Log-odds') %>%
  group_by(Comparison) %>%
  arrange(desc(spearman_corr)) %>%
  mutate(label = ifelse(row_number() %in% c(1:3,n()),drug,'')) %>%
  ungroup() %>%
  ggplot(aes(x=spearman_corr,y=pearson_corr,color=Comparison,label=label)) +
  geom_point(alpha=.5,size=1.5) +
  geom_text_repel(show.legend=FALSE,size=4) +
  theme_bw() 
ggsave(p, file=file.path(opt$log_dir,meas,paste('pairwise_study_agreements_broad.pdf',sep='')),width = 8, height = 8, units = "in")
saveRDS(p, file=file.path(opt$log_dir,meas,paste('pairwise_study_agreements_broad.RDS',sep='')))
```

Plot boxplot agreements for all pairwise cell comparisons.
```{r}
p <- pairwise_cell_agreements %>% 
  mutate(Drug_type = ifelse(Called == 'Targeted','Targeted','Broad')) %>%
  group_by(Comparison,drug, Drug_type) %>% 
  summarise(agreement=mean(agreement)) %>%
  ungroup() %>%
  ggplot(aes(x=Drug_type,y=agreement,fill=Comparison)) +
  geom_boxplot() + 
  theme_bw() 
ggsave(p, file=file.path(opt$log_dir,meas,paste('pairwise_cell_agreements.pdf',sep='')),width = 8, height = 8, units = "in")
saveRDS(p, file=file.path(opt$log_dir,meas,paste('pairwise_cell_agreements.RDS',sep='')))
```

Plot boxplot agreements for all pairwise drug comparisons.
```{r}
p <- pairwise_drug_agreements %>% 
  mutate(Drug_type = Called) %>%
  ggplot(aes(x=Drug_type,y=agreement,fill=Comparison)) +
  geom_boxplot() + 
  theme_bw() 
ggsave(p, file=file.path(opt$log_dir,meas,paste('pairwise_drug_agreements.pdf',sep='')),width = 8, height = 8, units = "in")
saveRDS(p, file=file.path(opt$log_dir,meas,paste('pairwise_drug_agreements.RDS',sep='')))
```

```{r}
rm(list=ls(all.names = TRUE))
```

